<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.bbut.iy.itemmaster.dao.ReturnsDailyMapper">

    <resultMap id="returnMap" type="cn.com.bbut.iy.itemmaster.dto.returnsDaily.ReturnsDailyDTO">
        <result column="article_id" property="articleId"></result>
        <result column="article_name" property="articleName"></result>
        <result column="barcode" property="barcode"></result>
        <result column="sale_date" property="saleDate"></result>
        <result column="tran_date" property="tranDate"></result>
        <result column="pos_id" property="posId"></result>
        <result column="sale_serial_no" property="saleSerialNo"></result>
        <result column="sale_qty" property="orderQty"></result>
        <result column="price_actual" property="priceActual"></result>
        <result column="sale_amount" property="orderAmt"></result>
        <result column="cashier_id" property="cashierId"></result>
        <result column="cashier_name" property="cashierName"></result>
        <result column="cash" property="cash"></result>
        <result column="suNingCard" property="suNingCard"></result>
        <result column="unionPay" property="unionPay"></result>
        <result column="commodityCoupon" property="commodityCoupon"></result>
        <result column="discountCoupon" property="discountCoupon"></result>
        <result column="prepaidCard" property="prepaidCard"></result>
        <result column="creditCar" property="creditCar"></result>
        <result column="store_cd" property="storeCd"></result>
        <result column="store_name" property="storeName"></result>
        <result column="non_sale_type" property="nonSaleType"></result>

        <result column="cardPayment" property="cardPayment"></result>
        <result column="eVoucher" property="eVoucher"></result>
        <result column="momo" property="momo"></result>
        <result column="payoo" property="payoo"></result>
        <result column="viettel" property="viettel"></result>
        <result column="totalAmt" property="totalAmt"></result>
        <result column="c_operatorcode" property="amCd"></result>
        <result column="c_operatorname" property="amName"></result>
        <result column="tran_serial_no" property="tranSerialNo"></result>
    </resultMap>

    <select id="selectByStoreCd" parameterType="java.lang.String"
            resultType="cn.com.bbut.iy.itemmaster.entity.base.Ma1000">
        SELECT
            A.store_cd AS storeCd,
            A.store_name AS storeName
        FROM
            MA1000 A
        WHERE
            A.store_cd = #{storeCd}
            AND #{businessDate} BETWEEN A.effective_start_date
            AND A.effective_end_date
        LIMIT 1
    </select>

    <select id="search" parameterType="cn.com.bbut.iy.itemmaster.dto.returnsDaily.ReturnsDailyParamDTO"
            resultMap="returnMap">
        SELECT
        B.article_id,
        C.article_name,
        A.tran_date,
        B.sale_date,
        B.barcode,
        to_char(B.sale_date,'dd/MM/yyyy') as sale_formt_date,
        B.pos_id,
        B.sale_serial_no,
        B.sale_qty,
        B.price_original,
        B.price_actual,
        B.sale_amount,
        sa21.non_sale_type,
        A.cashier_id,
        D.cashier_name,
        E.store_cd,
        E.store_name,
        oper.c_operatorcode,
        oper.c_operatorname,
        CASE WHEN A.pay_cd1='01' THEN B.sale_amount ELSE '0' END AS cash,
        CASE WHEN A.pay_cd1='02' THEN B.sale_amount ELSE '0' END AS cardPayment,
        CASE WHEN A.pay_cd1='03' THEN B.sale_amount ELSE '0' END AS eVoucher,
        CASE WHEN A.pay_cd1='04' THEN B.sale_amount ELSE '0' END AS momo,
        CASE WHEN A.pay_cd1='05' THEN B.sale_amount ELSE '0' END AS payoo,
        CASE WHEN A.pay_cd1='06' THEN B.sale_amount ELSE '0' END AS viettel,
        CASE WHEN A.pay_cd1='07' THEN B.sale_amount ELSE '0' END AS creditCard, /*creditCard 字段不用了*/
        (B.sale_amount) as totalAmt
        FROM
        SA0010 A
        left join SA0050 D on A.cashier_id = D.cashier_id and A.store_cd = D.store_cd,
        SA0020 B
        left join sa0021 sa21
        on sa21.acc_date=B.acc_date and sa21.store_cd=B.store_cd
        and sa21.pos_id=B.pos_id and sa21.tran_serial_no=B.tran_serial_no
        and sa21.item_code=B.article_id,
        MA1100 C,
        MA1000 E,
        t_operator oper
        WHERE
        A.tran_serial_no = B.tran_serial_no
        AND A.acc_date = B.acc_date
        AND A.store_cd = B.store_cd
        AND B.store_cd = E.store_cd
        AND B.acc_date BETWEEN E.effective_start_date AND E.effective_end_date
        AND E.ofc = oper.c_operatorcode
        AND A.pos_id = B.pos_id
        AND A.tran_type = 'return'
        AND B.detail_type = 'r'
        AND B.article_id = C.article_id
        AND B.acc_date BETWEEN C.effective_start_date AND C.effective_end_date
        AND A.store_cd IN
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        /*--早班*/
        <if test="param.shift!=null and param.shift=='00'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--中班*/
        <if test="param.shift!=null and param.shift=='01'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--晚班*/
        <if test="param.shift!=null and param.shift=='02'">
            <![CDATA[
                and (A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                or A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss'))
                ]]>
        </if>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND A.tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (A.tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>

        <if test="param.cashierCd!=null and param.cashierCd!=''">
            and A.cashier_id = trim(#{param.cashierCd})
        </if>
        <if test="param.nonSaleType!=null and param.nonSaleType!=''">
            and sa21.non_sale_type = trim(#{param.nonSaleType})
        </if>
        <if test="param.am!=null and param.am!=''">
            and E.ofc = #{param.am}
        </if>
        <if test="param.storeCd!=null and param.storeCd!=''">
            AND lower(A.store_cd) like lower(CONCAT('%',#{param.storeCd},'%'))
        </if>
        <if test="param.storeName!=null and param.storeName!=''">
            AND lower(E.store_name) like lower(CONCAT('%',#{param.storeName},'%'))
        </if>
        <if test="param.depCd != null and param.depCd != ''">
            and C.dep_cd = #{param.depCd,jdbcType=VARCHAR}
        </if>
        <if test="param.pmaCd != null and param.pmaCd != ''">
            and C.pma_cd = #{param.pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="param.categoryCd != null and param.categoryCd != ''">
            and C.category_cd = #{param.categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.subCategoryCd != null and param.subCategoryCd != ''">
            and C.sub_category_cd = #{param.subCategoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.articleName!=null and param.articleName!=''">
            AND concat(lower( C.article_id ),'',lower( C.article_name ),'',lower( C.article_name_en ),'',lower(
            C.article_short_name_en )) LIKE lower( CONCAT('%',#{articleName},'%') )
        </if>
        <if test="param.totalAmt != null and param.totalAmt != '' and param.calType != null and param.calType != ''" >
            <![CDATA[
            and B.sale_amount ${param.calType} cast(#{param.totalAmt,jdbcType=VARCHAR} as NUMERIC)
            ]]>
        </if>
        <if test="param.barcode != null and param.barcode != ''" >
            and B.barcode LIKE lower(CONCAT('%',#{param.barcode},'%')
        </if>
    </select>

    <select id="searchNoSale" parameterType="cn.com.bbut.iy.itemmaster.dto.returnsDaily.ReturnsDailyParamDTO"
            resultMap="returnMap">
        select
        A.article_id,
        C.article_name,
        to_char(A.tran_date, 'yyyyMMdd') as charDate,
        A.tran_date,
       /* B.barcode,*/
        A.pos_id,
        A.tran_serial_no,
        A.qty sale_qty,
        coalesce(A.qty * M13.base_sale_price,0) as totalAmt,
        sa21.non_sale_type,
        A.cashier_id,
        D.cashier_name,
        E.store_cd,
        E.store_name,
        oper.c_operatorcode,
        oper.c_operatorname
        FROM
        SA0580
        A LEFT JOIN SA0050 D ON A.cashier_id = D.cashier_id
        AND A.store_cd = D.store_cd
        LEFT JOIN sa0021 sa21 ON sa21.acc_date = A.acc_date
        AND sa21.store_cd = A.store_cd
        AND sa21.pos_id = A.pos_id
        AND sa21.tran_serial_no = A.tran_serial_no
        AND sa21.item_code = A.article_id,
        MA1100 C,
        MA1130 M13,
        MA1000 E,
        t_operator oper
        WHERE
        A.store_cd = E.store_cd
        AND A.acc_date BETWEEN E.effective_start_date
        AND E.effective_end_date
        AND E.ofc = oper.c_operatorcode
        AND A.article_id = C.article_id
        AND to_char(A.tran_date, 'yyyyMMdd') BETWEEN C.effective_start_date
        AND C.effective_end_date
        AND M13.article_id = C.article_id
        and M13.effective_start_date = C.effective_start_date
        and M13.structure_cd =
        (SELECT admin_structure_cd FROM ma0020 WHERE structure_cd=(SELECT admin_structure_cd FROM ma0020 WHERE structure_cd=A.store_cd))
        AND A.store_cd IN
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        /*--早班*/
        <if test="param.shift!=null and param.shift=='00'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--中班*/
        <if test="param.shift!=null and param.shift=='01'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--晚班*/
        <if test="param.shift!=null and param.shift=='02'">
            <![CDATA[
                and (A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                or A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss'))
                ]]>
        </if>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND A.tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (A.tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>

        <if test="param.cashierCd!=null and param.cashierCd!=''">
            and A.cashier_id = trim(#{param.cashierCd})
        </if>
        <if test="param.nonSaleType!=null and param.nonSaleType!=''">
            and sa21.non_sale_type = trim(#{param.nonSaleType})
        </if>
        <if test="param.am!=null and param.am!=''">
            and E.ofc = #{param.am}
        </if>

        <if test="param.depCd != null and param.depCd != ''">
            and C.dep_cd = #{param.depCd,jdbcType=VARCHAR}
        </if>
        <if test="param.pmaCd != null and param.pmaCd != ''">
            and C.pma_cd = #{param.pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="param.categoryCd != null and param.categoryCd != ''">
            and C.category_cd = #{param.categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.subCategoryCd != null and param.subCategoryCd != ''">
            and C.sub_category_cd = #{param.subCategoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.articleName!=null and param.articleName!=''">
            AND concat(lower( C.article_id ),'',lower( C.article_name ),'',lower( C.article_name_en ),'',lower(
            C.article_short_name_en )) LIKE lower( CONCAT('%',#{param.articleName},'%') )
        </if>
        <if test="param.totalAmt != null and param.totalAmt != '' and param.calType != null and param.calType != ''" >
            <![CDATA[
            and coalesce(A.qty * M13.base_sale_price,0) ${param.calType} cast(#{param.totalAmt,jdbcType=VARCHAR} as NUMERIC)
            ]]>
        </if>

        <!--<if test="param.barcode != null and param.barcode != ''" >
            and B.barcode LIKE lower(CONCAT('%',#{param.barcode},'%')
        </if>-->

        union

        SELECT B
        .article_id,
        C.article_name,
        to_char( A.tran_date, 'yyyyMMdd' ) AS charDate,
        A.tran_date,
        /* B.barcode,*/
        A.pos_id,
        A.tran_serial_no,
        B.sale_qty sale_qty,
        COALESCE ( B.sale_qty * M13.base_sale_price, 0 ) AS totalAmt,
        sa21.non_sale_type,
        A.cashier_id,
        D.cashier_name,
        E.store_cd,
        E.store_name,
        oper.c_operatorcode,
        oper.c_operatorname
        FROM
        SA0010
        A join SA0020 B
        on A.tran_serial_no = B.tran_serial_no
        AND A.acc_date = B.acc_date
        AND A.store_cd = B.store_cd
        AND A.pos_id = B.pos_id
        LEFT JOIN SA0050 D ON A.cashier_id = D.cashier_id
        AND A.store_cd = D.store_cd
        LEFT JOIN sa0021 sa21 ON to_char(a.tran_date, 'dd/mm/yyyy') = sa21.tran_date
        and to_char(a.tran_date, 'HH24:MI:ss') = sa21.tran_time
        AND sa21.store_cd = A.store_cd
        AND sa21.pos_id = A.pos_id
        AND sa21.tran_serial_no = A.tran_serial_no
        AND sa21.item_code = B.article_id,
        MA1100 C,
        MA1130 M13,
        MA1000 E,
        t_operator oper
        WHERE
        A.tran_type = 'return'
        AND B.detail_type in ( 'r','ra')
        AND A.store_cd = E.store_cd
        AND to_char( A.tran_date, 'yyyyMMdd' ) BETWEEN E.effective_start_date
        AND E.effective_end_date
        AND E.ofc = oper.c_operatorcode
        AND B.article_id = C.article_id
        AND to_char( A.tran_date, 'yyyyMMdd' ) BETWEEN C.effective_start_date
        AND C.effective_end_date
        AND M13.article_id = C.article_id
        AND M13.effective_start_date = C.effective_start_date
        AND M13.structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = A.store_cd ) )
        AND A.store_cd in
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        <if test="param.shift!=null and param.shift=='00'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        <if test="param.shift!=null and param.shift=='01'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        <if test="param.shift!=null and param.shift=='02'">
            <![CDATA[
                and (A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                or A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss'))
                ]]>
        </if>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND A.tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (A.tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>

        <if test="param.cashierCd!=null and param.cashierCd!=''">
            and A.cashier_id = trim(#{param.cashierCd})
        </if>
        <if test="param.nonSaleType!=null and param.nonSaleType!=''">
            and sa21.non_sale_type = trim(#{param.nonSaleType})
        </if>
        <if test="param.am!=null and param.am!=''">
            and E.ofc = #{param.am}
        </if>

        <if test="param.depCd != null and param.depCd != ''">
            and C.dep_cd = #{param.depCd,jdbcType=VARCHAR}
        </if>
        <if test="param.pmaCd != null and param.pmaCd != ''">
            and C.pma_cd = #{param.pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="param.categoryCd != null and param.categoryCd != ''">
            and C.category_cd = #{param.categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.subCategoryCd != null and param.subCategoryCd != ''">
            and C.sub_category_cd = #{param.subCategoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.articleName!=null and param.articleName!=''">
            AND concat(lower( C.article_id ),'',lower( C.article_name ),'',lower( C.article_name_en ),'',lower(
            C.article_short_name_en )) LIKE lower( CONCAT('%',#{param.articleName},'%') )
        </if>
        <if test="param.totalAmt != null and param.totalAmt != '' and param.calType != null and param.calType != ''" >
            <![CDATA[
            and coalesce(B.sale_qty * M13.base_sale_price,0) ${param.calType} cast(#{param.totalAmt,jdbcType=VARCHAR} as NUMERIC)
            ]]>
        </if>
        <!--<if test="param.barcode != null and param.barcode != ''" >
            and B.barcode LIKE lower(CONCAT('%',#{param.barcode},'%')
        </if>-->
        <if test="param.flg">
            LIMIT ${param.rows} OFFSET ${param.limitStart}
        </if>
    </select>

    <select id="getAllTranTime" parameterType="cn.com.bbut.iy.itemmaster.dto.returnsDaily.ReturnsDailyParamDTO"
            resultMap="returnMap">
        select
        store_cd,
        pos_id,
        tran_date,
        tran_type
        from sa0010
        WHERE
        tran_type in ('train_start','train_end')
        AND store_cd IN
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>
        ORDER BY store_cd,pos_id,tran_date
    </select>

    <select id="searchNoSaleCount" parameterType="cn.com.bbut.iy.itemmaster.dto.returnsDaily.ReturnsDailyParamDTO"
            resultType="Integer">
        select
        count(*)
        FROM
        (
        select
        A.article_id,
        C.article_name,
        to_char(A.tran_date, 'yyyyMMdd') as charDate,
        A.tran_date,
        /* B.barcode,*/
        A.pos_id,
        A.tran_serial_no,
        A.qty sale_qty,
        coalesce(A.qty * M13.base_sale_price,0) as totalAmt,
        sa21.non_sale_type,
        A.cashier_id,
        D.cashier_name,
        E.store_cd,
        E.store_name,
        oper.c_operatorcode,
        oper.c_operatorname
        FROM
        SA0580
        A LEFT JOIN SA0050 D ON A.cashier_id = D.cashier_id
        AND A.store_cd = D.store_cd
        LEFT JOIN sa0021 sa21 ON sa21.acc_date = A.acc_date
        AND sa21.store_cd = A.store_cd
        AND sa21.pos_id = A.pos_id
        AND sa21.tran_serial_no = A.tran_serial_no
        AND sa21.item_code = A.article_id,
        MA1100 C,
        MA1130 M13,
        MA1000 E,
        t_operator oper
        WHERE
        A.store_cd = E.store_cd
        AND A.acc_date BETWEEN E.effective_start_date
        AND E.effective_end_date
        AND E.ofc = oper.c_operatorcode
        AND A.article_id = C.article_id
        AND to_char(A.tran_date, 'yyyyMMdd') BETWEEN C.effective_start_date
        AND C.effective_end_date
        AND M13.article_id = C.article_id
        and M13.effective_start_date = C.effective_start_date
        and M13.structure_cd =
        (SELECT admin_structure_cd FROM ma0020 WHERE structure_cd=(SELECT admin_structure_cd FROM ma0020 WHERE structure_cd=A.store_cd))
        AND A.store_cd IN
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        /*--早班*/
        <if test="param.shift!=null and param.shift=='00'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--中班*/
        <if test="param.shift!=null and param.shift=='01'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--晚班*/
        <if test="param.shift!=null and param.shift=='02'">
            <![CDATA[
                and (A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                or A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss'))
                ]]>
        </if>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND A.tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (A.tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>

        <if test="param.cashierCd!=null and param.cashierCd!=''">
            and A.cashier_id = trim(#{param.cashierCd})
        </if>
        <if test="param.nonSaleType!=null and param.nonSaleType!=''">
            and sa21.non_sale_type = trim(#{param.nonSaleType})
        </if>
        <if test="param.am!=null and param.am!=''">
            and E.ofc = #{param.am}
        </if>

        <if test="param.depCd != null and param.depCd != ''">
            and C.dep_cd = #{param.depCd,jdbcType=VARCHAR}
        </if>
        <if test="param.pmaCd != null and param.pmaCd != ''">
            and C.pma_cd = #{param.pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="param.categoryCd != null and param.categoryCd != ''">
            and C.category_cd = #{param.categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.subCategoryCd != null and param.subCategoryCd != ''">
            and C.sub_category_cd = #{param.subCategoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.articleName!=null and param.articleName!=''">
            AND concat(lower( C.article_id ),'',lower( C.article_name ),'',lower( C.article_name_en ),'',lower(
            C.article_short_name_en )) LIKE lower( CONCAT('%',#{param.articleName},'%') )
        </if>
        <if test="param.totalAmt != null and param.totalAmt != '' and param.calType != null and param.calType != ''" >
            <![CDATA[
            and coalesce(A.qty * M13.base_sale_price,0) ${param.calType} cast(#{param.totalAmt,jdbcType=VARCHAR} as NUMERIC)
            ]]>
        </if>

        <!--<if test="param.barcode != null and param.barcode != ''" >
            and B.barcode LIKE lower(CONCAT('%',#{param.barcode},'%')
        </if>-->

        union

        SELECT B
        .article_id,
        C.article_name,
        to_char( A.tran_date, 'yyyyMMdd' ) AS charDate,
        A.tran_date,
        /* B.barcode,*/
        A.pos_id,
        A.tran_serial_no,
        B.sale_qty sale_qty,
        COALESCE ( B.sale_qty * M13.base_sale_price, 0 ) AS totalAmt,
        sa21.non_sale_type,
        A.cashier_id,
        D.cashier_name,
        E.store_cd,
        E.store_name,
        oper.c_operatorcode,
        oper.c_operatorname
        FROM
        SA0010
        A join SA0020 B
        on A.tran_serial_no = B.tran_serial_no
        AND A.acc_date = B.acc_date
        AND A.store_cd = B.store_cd
        AND A.pos_id = B.pos_id
        LEFT JOIN SA0050 D ON A.cashier_id = D.cashier_id
        AND A.store_cd = D.store_cd
        LEFT JOIN sa0021 sa21 ON to_char(a.tran_date, 'dd/mm/yyyy') = sa21.tran_date
        and to_char(a.tran_date, 'HH24:MI:ss') = sa21.tran_time
        AND sa21.store_cd = A.store_cd
        AND sa21.pos_id = A.pos_id
        AND sa21.tran_serial_no = A.tran_serial_no
        AND sa21.item_code = B.article_id,
        MA1100 C,
        MA1130 M13,
        MA1000 E,
        t_operator oper
        WHERE
        A.tran_type = 'return'
        AND B.detail_type in ( 'r','ra')
        AND A.store_cd = E.store_cd
        AND to_char( A.tran_date, 'yyyyMMdd' ) BETWEEN E.effective_start_date
        AND E.effective_end_date
        AND E.ofc = oper.c_operatorcode
        AND B.article_id = C.article_id
        AND to_char( A.tran_date, 'yyyyMMdd' ) BETWEEN C.effective_start_date
        AND C.effective_end_date
        AND M13.article_id = C.article_id
        AND M13.effective_start_date = C.effective_start_date
        AND M13.structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = A.store_cd ) )
        AND A.store_cd in
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        <if test="param.shift!=null and param.shift=='00'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        <if test="param.shift!=null and param.shift=='01'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        <if test="param.shift!=null and param.shift=='02'">
            <![CDATA[
                and (A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                or A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss'))
                ]]>
        </if>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND A.tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (A.tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>

        <if test="param.cashierCd!=null and param.cashierCd!=''">
            and A.cashier_id = trim(#{param.cashierCd})
        </if>
        <if test="param.nonSaleType!=null and param.nonSaleType!=''">
            and sa21.non_sale_type = trim(#{param.nonSaleType})
        </if>
        <if test="param.am!=null and param.am!=''">
            and E.ofc = #{param.am}
        </if>

        <if test="param.depCd != null and param.depCd != ''">
            and C.dep_cd = #{param.depCd,jdbcType=VARCHAR}
        </if>
        <if test="param.pmaCd != null and param.pmaCd != ''">
            and C.pma_cd = #{param.pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="param.categoryCd != null and param.categoryCd != ''">
            and C.category_cd = #{param.categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.subCategoryCd != null and param.subCategoryCd != ''">
            and C.sub_category_cd = #{param.subCategoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.articleName!=null and param.articleName!=''">
            AND concat(lower( C.article_id ),'',lower( C.article_name ),'',lower( C.article_name_en ),'',lower(
            C.article_short_name_en )) LIKE lower( CONCAT('%',#{param.articleName},'%') )
        </if>
        <if test="param.totalAmt != null and param.totalAmt != '' and param.calType != null and param.calType != ''" >
            <![CDATA[
            and coalesce(B.sale_qty * M13.base_sale_price,0) ${param.calType} cast(#{param.totalAmt,jdbcType=VARCHAR} as NUMERIC)
            ]]>
        </if>
        <!--<if test="param.barcode != null and param.barcode != ''" >
            and B.barcode LIKE lower(CONCAT('%',#{param.barcode},'%')
        </if>-->
        ) v
    </select>

    <select id="getItemTotal" parameterType="cn.com.bbut.iy.itemmaster.dto.returnsDaily.ReturnsDailyParamDTO"
            resultMap="returnMap">
        select
        sum(v.sale_qty) totalQty ,
        sum(v.totalAmt) as totalAmt
        FROM
        (
        select
        A.article_id,
        C.article_name,
        to_char(A.tran_date, 'yyyyMMdd') as charDate,
        A.tran_date,
        /* B.barcode,*/
        A.pos_id,
        A.tran_serial_no,
        A.qty sale_qty,
        coalesce(A.qty * M13.base_sale_price,0) as totalAmt,
        sa21.non_sale_type,
        A.cashier_id,
        D.cashier_name,
        E.store_cd,
        E.store_name,
        oper.c_operatorcode,
        oper.c_operatorname
        FROM
        SA0580
        A LEFT JOIN SA0050 D ON A.cashier_id = D.cashier_id
        AND A.store_cd = D.store_cd
        LEFT JOIN sa0021 sa21 ON sa21.acc_date = A.acc_date
        AND sa21.store_cd = A.store_cd
        AND sa21.pos_id = A.pos_id
        AND sa21.tran_serial_no = A.tran_serial_no
        AND sa21.item_code = A.article_id,
        MA1100 C,
        MA1130 M13,
        MA1000 E,
        t_operator oper
        WHERE
        A.store_cd = E.store_cd
        AND A.acc_date BETWEEN E.effective_start_date
        AND E.effective_end_date
        AND E.ofc = oper.c_operatorcode
        AND A.article_id = C.article_id
        AND to_char(A.tran_date, 'yyyyMMdd') BETWEEN C.effective_start_date
        AND C.effective_end_date
        AND M13.article_id = C.article_id
        and M13.effective_start_date = C.effective_start_date
        and M13.structure_cd =
        (SELECT admin_structure_cd FROM ma0020 WHERE structure_cd=(SELECT admin_structure_cd FROM ma0020 WHERE structure_cd=A.store_cd))
        AND A.store_cd IN
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        /*--早班*/
        <if test="param.shift!=null and param.shift=='00'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--中班*/
        <if test="param.shift!=null and param.shift=='01'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        /*--晚班*/
        <if test="param.shift!=null and param.shift=='02'">
            <![CDATA[
                and (A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                or A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss'))
                ]]>
        </if>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND A.tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (A.tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>

        <if test="param.cashierCd!=null and param.cashierCd!=''">
            and A.cashier_id = trim(#{param.cashierCd})
        </if>
        <if test="param.nonSaleType!=null and param.nonSaleType!=''">
            and sa21.non_sale_type = trim(#{param.nonSaleType})
        </if>
        <if test="param.am!=null and param.am!=''">
            and E.ofc = #{param.am}
        </if>

        <if test="param.depCd != null and param.depCd != ''">
            and C.dep_cd = #{param.depCd,jdbcType=VARCHAR}
        </if>
        <if test="param.pmaCd != null and param.pmaCd != ''">
            and C.pma_cd = #{param.pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="param.categoryCd != null and param.categoryCd != ''">
            and C.category_cd = #{param.categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.subCategoryCd != null and param.subCategoryCd != ''">
            and C.sub_category_cd = #{param.subCategoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.articleName!=null and param.articleName!=''">
            AND concat(lower( C.article_id ),'',lower( C.article_name ),'',lower( C.article_name_en ),'',lower(
            C.article_short_name_en )) LIKE lower( CONCAT('%',#{param.articleName},'%') )
        </if>
        <if test="param.totalAmt != null and param.totalAmt != '' and param.calType != null and param.calType != ''" >
            <![CDATA[
            and coalesce(A.qty * M13.base_sale_price,0) ${param.calType} cast(#{param.totalAmt,jdbcType=VARCHAR} as NUMERIC)
            ]]>
        </if>

        <!--<if test="param.barcode != null and param.barcode != ''" >
            and B.barcode LIKE lower(CONCAT('%',#{param.barcode},'%')
        </if>-->

        union

        SELECT B
        .article_id,
        C.article_name,
        to_char( A.tran_date, 'yyyyMMdd' ) AS charDate,
        A.tran_date,
        /* B.barcode,*/
        A.pos_id,
        A.tran_serial_no,
        B.sale_qty sale_qty,
        COALESCE ( B.sale_qty * M13.base_sale_price, 0 ) AS totalAmt,
        sa21.non_sale_type,
        A.cashier_id,
        D.cashier_name,
        E.store_cd,
        E.store_name,
        oper.c_operatorcode,
        oper.c_operatorname
        FROM
        SA0010
        A join SA0020 B
        on A.tran_serial_no = B.tran_serial_no
        AND A.acc_date = B.acc_date
        AND A.store_cd = B.store_cd
        AND A.pos_id = B.pos_id
        LEFT JOIN SA0050 D ON A.cashier_id = D.cashier_id
        AND A.store_cd = D.store_cd
        LEFT JOIN sa0021 sa21 ON to_char(a.tran_date, 'dd/mm/yyyy') = sa21.tran_date
        and to_char(a.tran_date, 'HH24:MI:ss') = sa21.tran_time
        AND sa21.store_cd = A.store_cd
        AND sa21.pos_id = A.pos_id
        AND sa21.tran_serial_no = A.tran_serial_no
        AND sa21.item_code = B.article_id,
        MA1100 C,
        MA1130 M13,
        MA1000 E,
        t_operator oper
        WHERE
        A.tran_type = 'return'
        AND B.detail_type in ( 'r','ra')
        AND A.store_cd = E.store_cd
        AND to_char( A.tran_date, 'yyyyMMdd' ) BETWEEN E.effective_start_date
        AND E.effective_end_date
        AND E.ofc = oper.c_operatorcode
        AND B.article_id = C.article_id
        AND to_char( A.tran_date, 'yyyyMMdd' ) BETWEEN C.effective_start_date
        AND C.effective_end_date
        AND M13.article_id = C.article_id
        AND M13.effective_start_date = C.effective_start_date
        AND M13.structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = A.store_cd ) )
        AND A.store_cd in
        <foreach item="store" index="index" collection="param.stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        <if test="param.shift!=null and param.shift=='00'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        <if test="param.shift!=null and param.shift=='01'">
            <![CDATA[
                and A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 14:00:00','yyyyMMdd hh24:mi:ss')
                and A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss')
                ]]>
        </if>
        <if test="param.shift!=null and param.shift=='02'">
            <![CDATA[
                and (A.tran_date < to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 06:00:00','yyyyMMdd hh24:mi:ss')
                or A.tran_date >= to_timestamp(to_char(A.tran_date,'yyyyMMdd')||' 22:00:00','yyyyMMdd hh24:mi:ss'))
                ]]>
        </if>
        <if test="param.returnDate!=null and param.returnDate!=''">
            <![CDATA[
        AND A.tran_date >= TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR}|| ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        and (A.tran_date - INTERVAL'1 day') < TO_TIMESTAMP(#{param.returnDate,jdbcType=VARCHAR} || ' ' ||'06:00:00', 'YYYY-MM-DD HH24:MI:SS')
        ]]>
        </if>

        <if test="param.cashierCd!=null and param.cashierCd!=''">
            and A.cashier_id = trim(#{param.cashierCd})
        </if>
        <if test="param.nonSaleType!=null and param.nonSaleType!=''">
            and sa21.non_sale_type = trim(#{param.nonSaleType})
        </if>
        <if test="param.am!=null and param.am!=''">
            and E.ofc = #{param.am}
        </if>

        <if test="param.depCd != null and param.depCd != ''">
            and C.dep_cd = #{param.depCd,jdbcType=VARCHAR}
        </if>
        <if test="param.pmaCd != null and param.pmaCd != ''">
            and C.pma_cd = #{param.pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="param.categoryCd != null and param.categoryCd != ''">
            and C.category_cd = #{param.categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.subCategoryCd != null and param.subCategoryCd != ''">
            and C.sub_category_cd = #{param.subCategoryCd,jdbcType=VARCHAR}
        </if>
        <if test="param.articleName!=null and param.articleName!=''">
            AND concat(lower( C.article_id ),'',lower( C.article_name ),'',lower( C.article_name_en ),'',lower(
            C.article_short_name_en )) LIKE lower( CONCAT('%',#{param.articleName},'%') )
        </if>
        <if test="param.totalAmt != null and param.totalAmt != '' and param.calType != null and param.calType != ''" >
            <![CDATA[
            and coalesce(B.sale_qty * M13.base_sale_price,0) ${param.calType} cast(#{param.totalAmt,jdbcType=VARCHAR} as NUMERIC)
            ]]>
        </if>
        <!--<if test="param.barcode != null and param.barcode != ''" >
            and B.barcode LIKE lower(CONCAT('%',#{param.barcode},'%')
        </if>-->
        ) v
 </select>

    <select id="getNextTranTime" parameterType="String" resultMap="returnMap">
        select
        store_cd,pos_id,tran_date,tran_type
        from sa0010
        WHERE
        store_cd = #{storeCd,jdbcType=VARCHAR}
				and pos_id = #{posId,jdbcType=VARCHAR}
        AND tran_date > to_timestamp(#{tranDate,jdbcType=VARCHAR},'YYYY-MM-DD HH24:MI:SS')
        ORDER BY store_cd,pos_id,tran_date limit 1;
    </select>
</mapper>