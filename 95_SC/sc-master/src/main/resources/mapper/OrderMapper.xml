<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.bbut.iy.itemmaster.dao.OrderMapper">
    <resultMap id="BaseResultMap" type="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDTO">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <result column="store_cd" jdbcType="CHAR" property="storeCd" />
        <result column="dep_cd" jdbcType="CHAR" property="depCd" />
        <result column="pma_cd" jdbcType="CHAR" property="pmaCd" />
        <result column="pma_name" jdbcType="VARCHAR" property="pmaName" />
        <result column="article_count" jdbcType="VARCHAR" property="articleCount" />
        <result column="can_order_count" jdbcType="VARCHAR" property="canOrderCount" />
        <result column="do_order_count" jdbcType="VARCHAR" property="doOrderCount" />
        <result column="shelf" jdbcType="VARCHAR" property="shelf" />
        <result column="position" jdbcType="VARCHAR" property="position" />
    </resultMap>
    <resultMap id="BaseResultMap1" type="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        <result column="store_cd" jdbcType="VARCHAR" property="storeCd" />
        <result column="article_id" jdbcType="VARCHAR" property="articleId" />
        <result column="article_name" jdbcType="VARCHAR" property="articleName" />
        <result column="vendor_id" jdbcType="VARCHAR" property="vendorId" />
        <result column="barcode" jdbcType="VARCHAR" property="barcode" />
        <result column="pma_name" jdbcType="VARCHAR" property="articleName" />
        <result column="realtime_stock" jdbcType="VARCHAR" property="realtimeStock" />
        <result column="auto_order_qty" jdbcType="VARCHAR" property="autoOrderQty" />
        <result column="psd" jdbcType="VARCHAR" property="psd" />
        <result column="dc_item" jdbcType="VARCHAR" property="dcItem" />
        <result column="purchase_unit_id" jdbcType="VARCHAR" property="purchaseUnitId" />
        <result column="order_qty" jdbcType="NUMERIC" property="orderQty" />
        <result column="order_price" jdbcType="NUMERIC" property="orderPrice" />
        <result column="order_nocharge_qty" jdbcType="NUMERIC" property="orderNochargeQty" />
        <result column="upload_order_qty" jdbcType="NUMERIC" property="uploadOrderQty" />
        <result column="upload_order_nocharge_qty" jdbcType="NUMERIC" property="uploadOrderNochargeQty" />
        <result column="upload_flg" jdbcType="VARCHAR" property="uploadFlg" />
        <result column="order_sts" jdbcType="VARCHAR" property="orderSts" />
        <result column="total_qty" jdbcType="VARCHAR" property="totalQty" />
        <result column="promotion_description" jdbcType="VARCHAR" property="promotionDescription" />
        <result column="write_off_qty" jdbcType="VARCHAR" property="writeOffQty" />
        <result column="article_qty" jdbcType="NUMERIC" property="articleQty" />
        <result column="article_nocharge_id" jdbcType="VARCHAR" property="articleNoChargeId" />
        <result column="article_nocharge_qty" jdbcType="NUMERIC" property="articleNoChargeQty" />

    </resultMap>
    <resultMap id="BaseResultMap2" type="cn.com.bbut.iy.itemmaster.dto.order.OrderDetailInfo">
        <result column="barcode" jdbcType="VARCHAR" property="barcode" />
        <result column="article_id" jdbcType="VARCHAR" property="articleId" />
        <result column="vendor_id" jdbcType="VARCHAR" property="vendorId" />
        <result column="vendor_name" jdbcType="VARCHAR" property="vendorName" />
        <result column="delivery_type_cd" jdbcType="VARCHAR" property="deliveryTypeCd" />
        <result column="delivery_type_name" jdbcType="VARCHAR" property="deliveryTypeName" />
        <result column="spec" jdbcType="VARCHAR" property="spec" />
        <result column="min_display_qty" jdbcType="NUMERIC" property="minDisplayQty" />
        <result column="unit_name" jdbcType="VARCHAR" property="unitName" />
        <result column="order_unit_qty" jdbcType="NUMERIC" property="orderUnitQty" />
        <result column="min_order_qty" jdbcType="NUMERIC" property="minOrderQty" />
        <result column="dc_min_order_qty" jdbcType="NUMERIC" property="dcMinOrderQty" />
        <result column="min_order_amt_tax" jdbcType="NUMERIC" property="minOrderAmtTax" />
        <result column="vendor_min_order_qty" jdbcType="NUMERIC" property="vendorMinOrderQty" />
        <result column="max_order_qty" jdbcType="NUMERIC" property="maxOrderQty" />
        <result column="order_batch_qty" jdbcType="NUMERIC" property="orderBatchQty" />
        <result column="order_promotion_type" jdbcType="VARCHAR" property="orderPromotionType" />
        <result column="base_order_price" jdbcType="NUMERIC" property="baseOrderPrice" />
        <result column="order_price" jdbcType="NUMERIC" property="orderPrice" />
        <result column="advise_sale_price" jdbcType="NUMERIC" property="adviseSalePrice" />
        <result column="dms" jdbcType="NUMERIC" property="dms" />
        <result column="warranty_days" jdbcType="NUMERIC" property="warrantyDays" />
        <result column="receive_date_limit" jdbcType="NUMERIC" property="receiveDateLimit" />
        <result column="sale_date_limit" jdbcType="NUMERIC" property="saleDateLimit" />
        <result column="preserve_type_name" jdbcType="VARCHAR" property="preserveTypeName" />

    </resultMap>
    <sql id="MA1100_WHERE_CLAUSE">
        and ma1100.article_id = ma1110.article_id
        and ma1100.effective_start_date = ma1110.effective_start_date
        /*取对应供应商商品*/
        and ma2240.store_cd = #{storeCd,jdbcType=VARCHAR}
        and ma2240.article_id = ma1110.article_id
        and ma2240.vendor_id = ma1110.vendor_id
        /*限制为dc商品*/
        <if test="dcItem != null and dcItem != ''">
            and ma1110.dc_item = #{dcItem,jdbcType=VARCHAR}
        </if>
        /*限制区域*/
        and ma1110.structure_cd = (
        select admin_structure_cd from MA0020 where structure_cd =
        (SELECT admin_structure_cd FROM MA0020 WHERE structure_cd = #{storeCd,jdbcType=VARCHAR} and effective_sts = '10') and effective_sts = '10'
        )
        <if test="depCd != null and depCd != ''">
            and ma1100.dep_cd = #{depCd,jdbcType=VARCHAR}
        </if>
        <if test="pmaCd != null and pmaCd != ''">
            and ma1100.pma_cd = #{pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="categoryCd != null and categoryCd != ''">
            and ma1100.category_cd = #{categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="subCategoryCd != null and subCategoryCd != ''">
            and ma1100.sub_category_cd = #{subCategoryCd,jdbcType=VARCHAR}
        </if>
    </sql>
    <sql id="MA8040_WHERE_CLAUSE">
        /*取对应供应商商品*/
        and ma2240.store_cd = #{storeCd,jdbcType=VARCHAR}
        and ma2240.article_id = ma8040.article_id
        and ma2240.vendor_id = ma8040.vendor_id
        /*限制为dc商品*/
        <if test="dcItem != null and dcItem != ''">
            and ma8040.dc_item = #{dcItem,jdbcType=VARCHAR}
        </if>
        /*限制订货为非暂停*/
        and (CASE
        when ma8040.dc_item = '1' then ma8040.order_pause_dc_flg = '1'
        when ma8040.dc_item = '0' then ma8040.order_pause_flg = '1'
        END)
        /*限制区域*/
        and ma8040.structure_cd = (
        select admin_structure_cd from MA0020 where structure_cd =
        (SELECT admin_structure_cd FROM MA0020 WHERE structure_cd = #{storeCd,jdbcType=VARCHAR} and effective_sts = '10') and effective_sts = '10'
        )
        /*限制dc商品的订货日历*/
        and ma5323.store_cd = #{storeCd,jdbcType=VARCHAR}
        and ma5323.warehouse_no = ma5322.warehouse_no
        and ma5323.schedule_id = ma5322.schedule_id
        and ((ma8040.dc_item='0') or (ma8040.dc_item='1' and (regexp_split_to_array(trim(ma5322.day_order),e'\\,'))[#{scheduleDay}] != '*'))
        <if test="depCd != null and depCd != '' and depCd !='999'">
            and ma8040.dep_cd = #{depCd,jdbcType=VARCHAR}
        </if>
        <if test="pmaCd != null and pmaCd != ''">
            and ma8040.pma_cd = #{pmaCd,jdbcType=VARCHAR}
        </if>
        <if test="categoryCd != null and categoryCd != ''">
            and ma8040.category_cd = #{categoryCd,jdbcType=VARCHAR}
        </if>
        <if test="subCategoryCd != null and subCategoryCd != ''">
            and ma8040.sub_category_cd = #{subCategoryCd,jdbcType=VARCHAR}
        </if>
    </sql>
    <select id="getOrderListByDpt" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap">
        select
        can_order.dep_cd,
        can_order.pma_cd,
        can_order.pma_name,
        can_order.dep_name,
        can_order.can_order_count,
        COALESCE ( article_count.num, 0 ) AS article_count,
        COALESCE ( do_order_count.num, 0 ) AS do_order_count
        from
        (
        SELECT ma8040.dep_cd,ma8040.pma_cd,ma0080.pma_name,ma0070.dep_name,
        coalesce(count(DISTINCT ma8040.article_id),0) as can_order_count
        FROM ma8140,ma0070,ma0080,ma2240,ma8040,ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma0070.dep_cd = ma8040.dep_cd
        and ma0080.dep_cd = ma8040.dep_cd and ma0080.pma_cd = ma8040.pma_cd
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        GROUP BY ma8040.dep_cd,ma8040.pma_cd,ma0070.dep_name,ma0080.pma_name
        ) can_order
        left join (select ma8040.dep_cd,ma8040.pma_cd,count(DISTINCT od8020.article_id) as num
        from ma8140,ma8040,od8020,ma2240,ma5322,ma5323 where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.article_id =  od8020.article_id
        and od8020.order_qty!=0
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
        and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
        group by dep_cd,pma_cd) do_order_count
        ON do_order_count.dep_cd = can_order.dep_cd and do_order_count.pma_cd = can_order.pma_cd
        left join (select dep_cd,pma_cd,count(DISTINCT ma1100.article_id) as num
        from ma1100,ma1110,ma2240 where
        #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
        <if test="vendorId !=null and vendorId != ''">
            and ma2240.vendor_id = #{vendorId,jdbcType=VARCHAR}
        </if>
        <include refid="MA1100_WHERE_CLAUSE"/>
        group by dep_cd,pma_cd) article_count
        ON article_count.dep_cd = can_order.dep_cd and article_count.pma_cd = can_order.pma_cd
        ORDER BY can_order.dep_cd ASC,can_order.pma_cd ASC
        <if test="limitStart >= 0">
            limit ${limitEnd} offset ${limitStart}
        </if>
    </select>

    <select id="getOrderListByDptCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="java.lang.Long">
        select
        count(*)
        from
        (
        SELECT ma8040.dep_cd,ma8040.pma_cd,ma0080.pma_name,ma0070.dep_name,
        coalesce(count(DISTINCT ma8040.article_id),0) as can_order_count
        FROM ma8140,ma0070,ma0080,ma2240,ma8040,ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma0070.dep_cd = ma8040.dep_cd
        and ma0080.dep_cd = ma8040.dep_cd and ma0080.pma_cd = ma8040.pma_cd and
        ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <include refid="MA8040_WHERE_CLAUSE"/>
        GROUP BY ma8040.dep_cd,ma8040.pma_cd,ma0070.dep_name,ma0080.pma_name
        ) can_order
    </select>

    <select id="getOrderListByShelf" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap">
        SELECT
            ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,
            coalesce(article_count.num,0) as article_count,
            coalesce(count(distinct ma8040.article_id),0) as can_order_count,
            coalesce(do_order_count.num,0) as do_order_count
        FROM ma8140,ma8040,ma2240,ma1105
        full join (
            select ma1105.shelf,count(DISTINCT od8020.article_id) as num
            from ma8140,ma8040,od8020,ma1105,ma2240,ma5322,ma5323
            where ma8040.article_id = ma8140.article_id
                and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
                and ma8040.article_id =  od8020.article_id
                and ma1105.item_code =  od8020.article_id
                and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
                and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
                AND od8020.order_qty !=0
                <if test="vendorId !=null and vendorId != ''">
                    and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
                    and ma8040.dc_item = '0'
                </if>
                and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
                and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
                <if test="pogCd != null and pogCd != ''">
                    AND ma1105.shelf = any (
                    array(SELECT shelf
                    FROM ma1108
                    WHERE ma1108.pog_cd = #{pogCd,jdbcType=VARCHAR}
                    AND ma1108.store_cd = #{storeCd,jdbcType=VARCHAR})
                    )
                </if>
                <if test="shelf != null and shelf != ''">
                    and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
                </if>
                <if test="subShelf != null and subShelf != ''">
                    and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
                </if>
                <include refid="MA8040_WHERE_CLAUSE"/>
                group by shelf
            ) do_order_count
        ON do_order_count.shelf = ma1105.shelf
        full join (
            select ma1105.shelf,count(DISTINCT ma1100.article_id) as num
            from ma1100,ma1105,ma1110,ma2240 where ma1105.item_code = ma1100.article_id
                and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR} and #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
                <if test="pogCd != null and pogCd != ''">
                    AND ma1105.shelf = any (
                    array(SELECT shelf
                    FROM ma1108
                    WHERE ma1108.pog_cd = #{pogCd,jdbcType=VARCHAR}
                    AND ma1108.store_cd = #{storeCd,jdbcType=VARCHAR})
                    )
                </if>
                <if test="shelf != null and shelf != ''">
                    and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
                </if>
                <if test="subShelf != null and subShelf != ''">
                    and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
                </if>
                <include refid="MA1100_WHERE_CLAUSE"/>
                <if test="vendorId !=null and vendorId != ''">
                    and ma2240.vendor_id = #{vendorId,jdbcType=VARCHAR}
                </if>
            group by ma1105.shelf) article_count
        ON article_count.shelf = ma1105.shelf
        LEFT JOIN (
            SELECT
                a.shelf,
                b.dep_cd,b.pma_cd,b.category_cd,b.sub_category_cd
            FROM
                (select ma1105.shelf, max(ma1100.article_id) article_id from ma1105,ma1100 where ma1105.item_code = ma1100.article_id GROUP BY ma1105.shelf) a
                left join
                (select article_id,dep_cd,pma_cd,category_cd,sub_category_cd from ma1100 ) b on a.article_id = b.article_id
            ORDER BY a.shelf ASC
        ) ma11 ON ma1105.shelf = ma11.shelf
        LEFT JOIN ma0090 ON ma11.category_cd = ma0090.category_cd
        AND ma11.dep_cd = ma0090.dep_cd
        AND ma11.pma_cd = ma0090.pma_cd
        LEFT JOIN ma0100 ON ma11.sub_category_cd = ma0100.sub_category_cd
        AND ma11.dep_cd = ma0100.dep_cd
        AND ma11.pma_cd = ma0100.pma_cd
        AND ma11.category_cd = ma0100.category_cd,
        ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.article_id = ma1105.item_code
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
        <if test="pogCd != null and pogCd != ''">
            AND ma1105.shelf = any (
            array(SELECT shelf
            FROM ma1108
            WHERE ma1108.pog_cd = #{pogCd,jdbcType=VARCHAR}
            AND ma1108.store_cd = #{storeCd,jdbcType=VARCHAR})
            )
        </if>
        <if test="shelf != null and shelf != ''">
            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
        </if>
        <if test="subShelf != null and subShelf != ''">
            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        GROUP BY ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,do_order_count.num,article_count.num
        ORDER BY ma1105.shelf ASC
        <if test="limitStart >= 0">
            limit ${limitEnd} offset ${limitStart}
        </if>
    </select>

    <select id="getOrderListDetail" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap1">
        select distinct
            ma8040.article_id,
            ma8040.article_name,
            ma8040.vendor_id,
            ma8040.purchase_unit_id,
            ma8040.base_order_price order_price,
            ma8040.dc_item,
            ma8040.promotion_description,
            coalesce(ma8040.article_qty,0) article_qty,
            concat(ma8040.article_nocharge_id,' ',ma1100.article_name) article_nocharge_id,
            coalesce(ma8040.article_nocharge_qty,0) article_nocharge_qty,
            coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR}
            and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
            coalesce(od8020.order_qty,0)+coalesce(od8020.order_nocharge_qty,0) AS total_qty,
            od8020.order_qty as order_qty,
            od8020.order_nocharge_qty,
            od8020.upload_flg,
            od8020.order_sts,
            od8020.upload_order_qty,
            od8020.upload_order_nocharge_qty,
            (select ma8070.psd ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and ma8070.article_id=ma8040.article_id) as psd,
            (select avg(sk0020.qty1) from sk0020 where sk0020.store_cd = #{storeCd,jdbcType=VARCHAR} and sk0020.article_id = ma8040.article_id and sk0020.voucher_type = '603'
            and sk0020.voucher_date between to_char(TO_DATE(#{orderDate,jdbcType=VARCHAR},'yyyyMMdd') - INTERVAL '28 day', 'yyyyMMdd') and #{orderDate,jdbcType=VARCHAR}) as write_off_qty
        from ma2240,ma8140,ma1105,ma8040
            full join od8020 ON od8020.article_id=ma8040.article_id
            and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
            and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
            left join ma1100 on ma8040.article_nocharge_id = ma1100.article_id
            and #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
            AND ma1100.inventory_item='1',
            ma5322,ma5323
        where
            ma8040.article_id = ma8140.article_id
            and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma1105.item_code = ma8040.article_id
            and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="articleId !=null and articleId != ''">
            and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
        </if>
        <if test="articleName !=null and articleName != ''">
            and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
        </if>
        <if test="barcode !=null and barcode != ''">
            and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
        </if>
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        <if test="shelf !=null and shelf != ''">
            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
        </if>
        <if test="subShelf !=null and subShelf != ''">
            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
        </if>
        order by ma8040.article_id ASC
        <if test="limitStart >= 0">
            limit ${limitEnd} offset ${limitStart}
        </if>
    </select>

    <select id="getOrderListDetailCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="long">
        select count(*) from (
        select
        distinct
        ma8040.article_id,
        ma8040.article_name,
        ma8040.vendor_id,
        ma8040.purchase_unit_id,
        ma8040.base_order_price order_price,
        ma8040.dc_item,
        ma8040.promotion_description,
        coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR}
        and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
        coalesce(od8020.order_qty,0)+coalesce(od8020.order_nocharge_qty,0) AS total_qty,
        od8020.order_qty as order_qty,
        od8020.order_nocharge_qty,
        od8020.upload_flg,
        od8020.order_sts,
        od8020.upload_order_qty,
        od8020.upload_order_nocharge_qty,
        (select ma8070.psd ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and ma8070.article_id=ma8040.article_id) as psd,
        (select avg(sk0020.qty1) from sk0020 where sk0020.store_cd = #{storeCd,jdbcType=VARCHAR} and sk0020.article_id = ma8040.article_id and sk0020.voucher_type = '603'
        and sk0020.voucher_date between to_char(TO_DATE(#{orderDate,jdbcType=VARCHAR},'yyyyMMdd') - INTERVAL '28 day', 'yyyyMMdd') and #{orderDate,jdbcType=VARCHAR}) as write_off_qty
        from ma2240,ma8140,ma1105,ma8040
        full join od8020 ON od8020.article_id=ma8040.article_id
        and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
        and od8020.store_cd = #{storeCd,jdbcType=VARCHAR},
        ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma1105.item_code = ma8040.article_id
        and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="articleId !=null and articleId != ''">
            and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
        </if>
        <if test="articleName !=null and articleName != ''">
            and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
        </if>
        <if test="barcode !=null and barcode != ''">
            and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
        </if>
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        <if test="shelf !=null and shelf != ''">
            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
        </if>
        <if test="subShelf !=null and subShelf != ''">
            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
        </if>
        ) orderCount
    </select>

    <select id="getOrderListDetailByDpt" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap1">
        select distinct
            ma8040.article_id,
            ma8040.article_name,
            ma8040.vendor_id,
            ma8040.purchase_unit_id,
            ma8040.base_order_price order_price,
            ma8040.dc_item,
            coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR}
            and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
            coalesce(od8020.order_qty,0)+coalesce(od8020.order_nocharge_qty,0) AS total_qty,
            od8020.order_qty as order_qty,
            od8020.order_nocharge_qty,
            od8020.upload_flg,
            od8020.order_sts,
            od8020.upload_order_qty,
            od8020.upload_order_nocharge_qty,
            (select ma8070.psd ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and ma8070.article_id=ma8040.article_id) as psd
        from ma2240,ma8140,ma8040
            full join od8020 ON od8020.article_id=ma8040.article_id
            and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
            and od8020.store_cd = #{storeCd,jdbcType=VARCHAR},
            ma5322,ma5323
        where
            ma8040.article_id = ma8140.article_id
            and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="articleId !=null and articleId != ''">
            and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
        </if>
        <if test="articleName !=null and articleName != ''">
            and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
        </if>
        <if test="barcode !=null and barcode != ''">
            and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
        </if>
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        order by ma8040.article_id ASC
        <if test="limitStart >= 0">
            limit ${limitEnd} offset ${limitStart}
        </if>
    </select>

    <select id="getOrderListDetailByDptCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="long">
        select count(*) from (
        select distinct
            ma8040.article_id,
            ma8040.article_name,
            ma8040.vendor_id,
            ma8040.purchase_unit_id,
            ma8040.base_order_price order_price,
            ma8040.dc_item,
            coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
            coalesce(od8020.order_qty,0)+coalesce(od8020.order_nocharge_qty,0) AS total_qty,
            od8020.order_qty as order_qty,
            od8020.order_nocharge_qty,
            od8020.upload_flg,
            od8020.order_sts,
            od8020.upload_order_qty,
            od8020.upload_order_nocharge_qty,
            (select ma8070.psd ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and ma8070.article_id=ma8040.article_id) as psd
        from ma2240,ma8140, ma8040
            full join od8020 ON od8020.article_id=ma8040.article_id
            and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
            and od8020.store_cd = #{storeCd,jdbcType=VARCHAR},
            ma5322,ma5323
        where
            ma8040.article_id = ma8140.article_id
            and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="articleId !=null and articleId != ''">
            and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
        </if>
        <if test="articleName !=null and articleName != ''">
            and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
        </if>
        <if test="barcode !=null and barcode != ''">
            and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
        </if>
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        ) orderCount
    </select>

    <select id="getOrderItemDetail" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap2">
        select
        DISTINCT
        c.barcode,
        ma8040.article_id,
        ma8040.vendor_id,
        concat(ma8040.vendor_id,' ',ma2000.vendor_name) vendor_name,
        /* ma2000.min_order_qty vendor_min_order_qty,*/
        ma2002.min_order_qty vendor_min_order_qty,/*供应商最低订货量*/
        (select code_name preserve_type_name from cm9010 where/*储藏信息*/
        ma1100.preserve_type = cm9010.code_value
        and cm9010.code_type = '00130'
        and effective_sts = '10') preserve_type_name,
        ma8040.spec,
        ma8040.promotion_description,
        ma0220.unit_name,
        /*ma8040.purchase_unit_id,*/
        ma8040.min_display_qty,
        ma8040.order_unit_qty,
        COALESCE(ma8040.min_order_qty, 0) min_order_qty,/*最低订货量*/
        COALESCE(ma8040.dc_m_order_qty, 0) dc_min_order_qty,/*dc moq*/
        ma8040.max_order_qty,
        ma8040.min_order_amt_tax,/*最低订货金额*/
        ma8040.order_batch_qty,
        (select code_name order_promotion_type from cm9010 where/*进价促销类型*/
        ma8040.order_promotion_type = cm9010.code_value
        and cm9010.code_type = '00826'
        and effective_sts = '10') order_promotion_type,
        ma8040.base_order_price order_price,
        ma8040.advise_sale_price,
        sk0000_today.dms,
        ma8040.warranty_days,
        ma8040.receive_date_limit,
        ma8040.sale_date_limit
        from ma8040
        left join
        sk0000_today on  ma8040.article_id = sk0000_today.article_id
        AND sk0000_today.effective_date = #{orderDate,jdbcType=VARCHAR}
        and sk0000_today.store_cd = #{storeCd,jdbcType=VARCHAR},
        ma0220,ma1100,ma2240,
        (SELECT
        ma1110.article_id,
        ma1110.vendor_id,
        ma1110.default_barcode  AS barcode,
        ma1110.structure_cd
        FROM
        ma1110
        WHERE
        #{orderDate,jdbcType=VARCHAR} between ma1110.effective_start_date and ma1110.effective_end_date
        ) c,
        ma2000
        left join ma2002 on
        ma2002.effective_start_date = ma2000.effective_start_date
        AND ma2000.vendor_id = ma2002.vendor_id
        /*限制区域*/
        and ma2002.structure_cd = (
        select admin_structure_cd from MA0020 where structure_cd =
        (SELECT admin_structure_cd FROM MA0020 WHERE structure_cd = #{storeCd,jdbcType=VARCHAR} and effective_sts = '10') and effective_sts = '10'
        )
        where
        ma8040.article_id = c.article_id
        and ma8040.structure_cd = c.structure_cd
        and ma8040.vendor_id = c.vendor_id
        /*限制区域*/
        and ma8040.structure_cd = (
        select admin_structure_cd from MA0020 where structure_cd =
        (SELECT admin_structure_cd FROM MA0020 WHERE structure_cd = #{storeCd,jdbcType=VARCHAR} and effective_sts = '10') and effective_sts = '10'
        )
        /*限制为dc商品*/
        <if test="dcItem != null and dcItem != ''">
            and ma8040.dc_item = #{dcItem,jdbcType=VARCHAR}
        </if>
        /*取对应供应商商品*/
        and ma2240.store_cd = #{storeCd,jdbcType=VARCHAR}
        and ma2240.article_id = ma8040.article_id
        and ma2240.vendor_id = ma8040.vendor_id
        /*限制订货为非暂停*/
        and (CASE
        when ma8040.dc_item = '1' then ma8040.order_pause_dc_flg = '1'
        when ma8040.dc_item = '0' then ma8040.order_pause_flg = '1'
        END)
        and ma8040.article_id = #{articleId,jdbcType=VARCHAR}
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.vendor_id= ma2000.vendor_id
        and ma1100.article_id = ma8040.article_id
        and #{orderDate,jdbcType=VARCHAR} BETWEEN ma1100.effective_start_date AND ma1100.effective_end_date
        and ma0220.unit_id =ma8040.purchase_unit_id
        <![CDATA[
      and #{orderDate,jdbcType=VARCHAR}>= ma2000.effective_start_date
      and #{orderDate,jdbcType=VARCHAR}<= ma2000.effective_end_date;
      ]]>
    </select>


    <select id="getOrderListByShelfCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="java.lang.Long">
        select count(*)
        from (
            SELECT
                ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,
                coalesce(article_count.num,0) as article_count,
                coalesce(count(distinct ma8040.article_id),0) as can_order_count,
                coalesce(do_order_count.num,0) as do_order_count
            FROM
                ma8140,ma8040,ma2240,ma1105
                full join (
                    select ma1105.shelf,count(DISTINCT od8020.article_id) as num
                    from ma8140,ma8040,od8020,ma1105,ma2240,ma5322,ma5323
                    where
                        ma8040.article_id = ma8140.article_id
                        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
                        and ma8040.article_id =  od8020.article_id
                        and ma1105.item_code =  od8020.article_id
                        and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
                        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
                        and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
                        and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
                        and  od8020.order_qty !=0
                        <if test="pogCd != null and pogCd != ''">
                            AND ma1105.shelf = any (
                            array(SELECT shelf
                            FROM ma1108
                            WHERE ma1108.pog_cd = #{pogCd,jdbcType=VARCHAR}
                            AND ma1108.store_cd = #{storeCd,jdbcType=VARCHAR})
                            )
                        </if>
                        <if test="shelf != null and shelf != ''">
                            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
                        </if>
                        <if test="subShelf != null and subShelf != ''">
                            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
                        </if>
                        <include refid="MA8040_WHERE_CLAUSE"/>
                        group by shelf
            ) do_order_count
            ON do_order_count.shelf = ma1105.shelf
            full join (
                select ma1105.shelf,count(DISTINCT ma1100.article_id) as num
                from ma1100,ma1105,ma1110,ma2240
                where ma1105.item_code = ma1100.article_id
                    and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR} and #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
                    <if test="pogCd != null and pogCd != ''">
                        AND ma1105.shelf = any (
                        array(SELECT shelf
                        FROM ma1108
                        WHERE ma1108.pog_cd = #{pogCd,jdbcType=VARCHAR}
                        AND ma1108.store_cd = #{storeCd,jdbcType=VARCHAR})
                        )
                    </if>
                    <if test="shelf != null and shelf != ''">
                        and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
                    </if>
                    <if test="subShelf != null and subShelf != ''">
                        and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
                    </if>
                <include refid="MA1100_WHERE_CLAUSE"/>
                group by ma1105.shelf
            ) article_count
            ON article_count.shelf = ma1105.shelf
            LEFT JOIN (
                SELECT a.shelf,b.dep_cd,b.pma_cd,b.category_cd,b.sub_category_cd
                FROM (select ma1105.shelf, max(ma1100.article_id) article_id from ma1105,ma1100 where ma1105.item_code = ma1100.article_id GROUP BY ma1105.shelf) a
                left join (select article_id,dep_cd,pma_cd,category_cd,sub_category_cd from ma1100 ) b on a.article_id = b.article_id
                ORDER BY a.shelf ASC) ma11
            ON ma1105.shelf = ma11.shelf
            LEFT JOIN ma0090 ON ma11.category_cd = ma0090.category_cd
            AND ma11.dep_cd = ma0090.dep_cd
            AND ma11.pma_cd = ma0090.pma_cd
            LEFT JOIN ma0100 ON ma11.sub_category_cd = ma0100.sub_category_cd
            AND ma11.dep_cd = ma0100.dep_cd
            AND ma11.pma_cd = ma0100.pma_cd
            AND ma11.category_cd = ma0100.category_cd,
            ma5322,ma5323
            where
            ma8040.article_id = ma8140.article_id
            and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma8040.article_id = ma1105.item_code
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
            <if test="pogCd != null and pogCd != ''">
                AND ma1105.shelf = any (
                array(SELECT shelf
                FROM ma1108
                WHERE ma1108.pog_cd = #{pogCd,jdbcType=VARCHAR}
                AND ma1108.store_cd = #{storeCd,jdbcType=VARCHAR})
                )
            </if>
            <if test="shelf != null and shelf != ''">
                and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
            </if>
            <if test="subShelf != null and subShelf != ''">
                and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
            </if>
            <include refid="MA8040_WHERE_CLAUSE"/>
            GROUP BY ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,do_order_count.num,article_count.num
            ORDER BY ma1105.shelf ASC) c
    </select>

    <select id="selectOrder" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO" resultMap="BaseResultMap1">
        select od8020.article_id,od8020.order_qty,od8020.upload_order_qty from od8020
        where od8020.article_id = #{articleId,jdbcType=VARCHAR}
        and od8020.order_date = #{orderDate,jdbcType=CHAR}
        and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
    </select>

    <delete id="deleteOrder"  parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        delete from od8020
        where od8020.article_id = #{articleId,jdbcType=VARCHAR}
        and od8020.order_date = #{orderDate,jdbcType=CHAR}
        and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
    </delete>

    <update id="updateOrder" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        update od8020
        <if test="orderQty!=null">
            set order_qty = #{orderQty,jdbcType=NUMERIC},
        </if>
        <!--<if test="orderNochargeQty!=null">
            set order_nocharge_qty = order_nocharge_qty+#{orderNochargeQty,jdbcType=NUMERIC},
        </if>-->
        <if test="orderPrice!=null">
            order_price = #{orderPrice,jdbcType=NUMERIC},
        </if>
        <if test="vendorId!=null">
            vendor_id = #{vendorId,jdbcType=VARCHAR},
        </if>
        <if test="dcItem!=null">
            dc_item = #{dcItem,jdbcType=CHAR},
        </if>
        <if test="orderSts!=null">
            order_sts = #{orderSts,jdbcType=CHAR},
        </if>
        update_user_id = #{updateUserId,jdbcType=NUMERIC},
        update_ymd = #{updateYmd,jdbcType=CHAR},
        update_hms = #{updateHms,jdbcType=CHAR}
        where od8020.article_id = #{articleId,jdbcType=VARCHAR}
        and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
        and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
    </update>

    <insert id="insertOrder" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        insert into od8020
            (store_cd, order_date, article_id, shipment_cd, vendor_id, receive_unit_id, order_qty, order_price,
            create_user_id, create_ymd, create_hms, update_user_id, update_ymd, update_hms, dc_item, order_sts)
            VALUES (#{storeCd,jdbcType=CHAR},
                    #{orderDate,jdbcType=CHAR},
                    #{articleId,jdbcType=VARCHAR},
                    #{shipmentCd,jdbcType=CHAR},
                    #{vendorId,jdbcType=CHAR},
                    #{purchaseUnitId,jdbcType=VARCHAR},
                    #{orderQty,jdbcType=NUMERIC},
                    #{orderPrice,jdbcType=NUMERIC},
                    #{createUserId,jdbcType=VARCHAR},
                    #{createYmd,jdbcType=CHAR},
                    #{createHms,jdbcType=CHAR},
                    #{updateUserId,jdbcType=VARCHAR},
                    #{updateYmd,jdbcType=CHAR},
                    #{updateHms,jdbcType=CHAR},
                    #{dcItem,jdbcType=CHAR},
                    #{orderSts,jdbcType=CHAR}
                    )
    </insert>
    <insert id="insertAudit">
        insert into od8025(order_id) values (#{storeCd,jdbcType=VARCHAR}||#{orderDate,jdbcType=VARCHAR})
        ON CONFLICT (order_id) DO NOTHING;
    </insert>

    <select id="checkOrder" resultMap="BaseResultMap1">
        select od8020.store_cd,od8020.article_id,ma1100.article_name from od8020,ma1100
        where
        od8020.dc_item = '0'
        and od8020.order_sts = '1'
				and od8020.article_id = ma1100.article_id
				and od8020.order_date BETWEEN ma1100.effective_start_date and ma1100.effective_end_date
        and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
        and od8020.order_date = #{orderDate,jdbcType=VARCHAR}
    </select>


    <select id="checkVendorOrder" resultType="java.lang.Integer">
        select count(*) from od8020
        where
        dc_item = '0'
        and store_cd = #{storeCd,jdbcType=VARCHAR}
        and order_date = #{orderDate,jdbcType=VARCHAR}
    </select>

    <select id="getPromotionInfo_bak" resultType="cn.com.bbut.iy.itemmaster.dto.order.PromotionDTO">
        select
        store_cd,article_id,order_price,pro_purchase_price
        from ma8170
        <where>
            and store_cd = #{storeCd,jdbcType=VARCHAR}
            and article_id = #{articleId,jdbcType=VARCHAR}
            and effective_date = #{effectiveDate,jdbcType=VARCHAR}
            and except_type = #{exceptType,jdbcType=VARCHAR}
            and vendor_id = #{vendorId,jdbcType=VARCHAR}
            <if test="promotionCd != null and promotionCd != ''">
                and promotion_cd = #{promotionCd,jdbcType=VARCHAR}
            </if>
        </where>
        limit 1
    </select>
    <select id="getPromotionInfo" resultType="cn.com.bbut.iy.itemmaster.dto.order.PromotionDTO">
        select
        ma8170.except_type,
        ma8170.promotion_cd,
        ma8170.store_cd,
        ma8170.article_id,
        ma8170.order_price,
        ma8170.pro_purchase_price,
        ma8080.update_ymd,
        ma8080.update_hms
        from ma8170,ma8080
        <where>
            and ma8170.promotion_cd = ma8080.promotion_cd
            and ma8170.effective_date = ma8080.effective_date
            and ma8170.article_id = ma8080.article_id
            and ma8170.store_cd = #{storeCd,jdbcType=VARCHAR}
            and ma8170.article_id = #{articleId,jdbcType=VARCHAR}
            and ma8170.effective_date = #{effectiveDate,jdbcType=VARCHAR}
            and ma8170.vendor_id = #{vendorId,jdbcType=VARCHAR}
            <if test="promotionCd != null and promotionCd != ''">
                and promotion_cd = #{promotionCd,jdbcType=VARCHAR}
            </if>
        </where>
        order by ma8080.update_ymd desc,ma8080.update_hms desc
        limit 1
    </select>
    <select id="getMa8040" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        select
        ma8040.base_order_price,
        ma8040.order_price,
        ma8040.order_promotion_cd,
        ma8080.update_ymd,
        ma8080.update_hms
        from ma8040 left join ma8080
        on  ma8040.order_promotion_cd = ma8080.promotion_cd
        and ma8040.effective_date = ma8080.effective_date
        and ma8040.article_id = ma8080.article_id
        and ma8040.structure_cd = ma8080.structure_cd
        <where>
            and ma8040.structure_cd = (
            select admin_structure_cd from MA0020 where structure_cd =
            (SELECT admin_structure_cd FROM MA0020 WHERE structure_cd = #{storeCd,jdbcType=VARCHAR} and effective_sts = '10') and effective_sts = '10'
            )
            and ma8040.article_id = #{articleId,jdbcType=VARCHAR}
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
        </where>
        limit 1
    </select>

    <select id="getStoreListNotOrder" resultType="cn.com.bbut.iy.itemmaster.dto.base.AutoCompleteDTO">
        select distinct ma1000.store_cd k,CONCAT(ma1000.store_cd,' ',ma1000.store_name_en) v from ma1000
        /*,ma1106*/
        where
        <![CDATA[
        effective_start_date <= #{businessDate,jdbcType=VARCHAR}
        and effective_end_date >= #{businessDate,jdbcType=VARCHAR}
        ]]>
        /*and ma1000.store_cd not in (
        select distinct store_cd from od0000 where order_type = '01'
        )
        and ma1000.store_cd = ma1106.store_cd
        and ma1106.review_status = 10*/
        and ma1000.store_cd in
        <foreach item="store" index="index" collection="stores"
                 open="(" separator="," close=")">
            #{store,jdbcType=VARCHAR}
        </foreach>
        <if test="v != null and v !=''">
            and (
            lower(ma1000.store_cd) like lower(CONCAT('%',#{v,jdbcType=VARCHAR},'%'))
            or lower(ma1000.store_name) like lower(CONCAT('%',#{v,jdbcType=VARCHAR},'%'))
            or lower(ma1000.store_name_en) like lower(CONCAT('%',#{v,jdbcType=VARCHAR},'%'))
            )
        </if>
    </select>
    <select id="getOrderOpenDate" resultType="String">
        select
         to_char(to_date(a.open_date, 'yyyymmdd') + cast(c.sp_value as int), 'yyyymmdd') as open_date
        from ma1000 a,cm9060 c
        where a.store_cd = #{storeCd,jdbcType=VARCHAR}
            and #{businessDate,jdbcType=VARCHAR} BETWEEN a.effective_start_date and a.effective_end_date
            and c.sp_id = '0221'
    </select>

    <select id="getOrderInfoByVendor" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        SELECT
            vendor_id,sum(coalesce(order_qty,0)) order_qty,sum(coalesce(order_qty,0)*coalesce(order_price,0)) order_price
        FROM od8020
            where
            order_date = #{businessDate,jdbcType=VARCHAR}
            and store_cd = #{storeCd,jdbcType=VARCHAR}
            and dc_item = '0'  GROUP BY vendor_id
    </select>

    <select id="getOrderInfoByVendorGroup" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        SELECT
            sum(coalesce(order_qty,0)) order_qty,sum(coalesce(order_qty,0)*coalesce(order_price,0)) order_price
        FROM od8020
            where
            order_date = #{businessDate,jdbcType=VARCHAR}
            and store_cd = #{storeCd,jdbcType=VARCHAR}
            and dc_item = '0'
			and vendor_id = #{vendorId,jdbcType = VARCHAR}
			and article_id in (
				select article_id from ma2400 where
					ma2400.vendor_id = #{vendorId,jdbcType = VARCHAR}
					AND ma2400.group_code = #{groupCode,jdbcType=VARCHAR}
					AND ma2400.structure_cd = (
						SELECT
							admin_structure_cd
						FROM
							ma0020
						WHERE
							structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = #{storeCd,jdbcType = VARCHAR})))
    </select>

    <select id="getOrderInfoByItem" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        SELECT
            od8020.article_id,ma1100.article_name,od8020.vendor_id,ma2000.vendor_name,
            coalesce(order_qty,0) order_qty,(coalesce(order_qty,0)*coalesce(order_price,0)) order_price
        FROM od8020,ma2000,ma1100
            where
            od8020.order_date = #{businessDate,jdbcType=VARCHAR}
            and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
            and od8020.article_id = ma1100.article_id
            and #{businessDate,jdbcType = VARCHAR} BETWEEN ma1100.effective_start_date AND ma2000.effective_end_date
            and #{businessDate,jdbcType = VARCHAR} BETWEEN ma2000.effective_start_date AND ma2000.effective_end_date
            and od8020.vendor_id = ma2000.vendor_id
            and od8020.dc_item = '0'
    </select>

    <select id="getGroupDetailByVendor" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderVendorDetailDTO">
            SELECT distinct
        ma2000.vendor_id,
        ma2000.vendor_name,
        ma2400.group_code,
        COALESCE ( ma2400.min_order_qty, 0 ) min_order_qty,
        COALESCE ( ma2400.min_order_amt, 0 ) min_order_amt
    FROM
        ma2000,
        ma2400
    WHERE
        ma2000.vendor_id = ma2400.vendor_id
        AND ma2400.vendor_id = #{ vendorId,jdbcType = VARCHAR}
        AND #{businessDate,jdbcType = VARCHAR} BETWEEN ma2000.effective_start_date AND ma2000.effective_end_date
        AND ma2400.structure_cd = (
    SELECT
        admin_structure_cd
    FROM
        ma0020
    WHERE
        structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = #{storeCd,jdbcType = VARCHAR})
        )
    </select>

    <select id="getVendorDetailByCity" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderVendorDetailDTO">
        select ma2000.vendor_id,ma2000.vendor_name,coalesce(ma2002.min_order_qty,0) min_order_qty,coalesce(ma2002.min_order_amt,0) min_order_amt
            from ma2000,ma2002
        where ma2000.vendor_id = ma2002.vendor_id
        and ma2000.effective_start_date = ma2002.effective_start_date
        and ma2000.vendor_id = #{vendorId,jdbcType=VARCHAR}
        and #{businessDate,jdbcType=VARCHAR}
                BETWEEN ma2000.effective_start_date AND ma2000.effective_end_date
        and ma2002.structure_cd = (
                    select admin_structure_cd from ma0020
                    where structure_cd = (
                            select admin_structure_cd from ma0020
                            where structure_cd = #{storeCd,jdbcType=VARCHAR}
                    )
            )
    </select>
    <select id="getItemDerailByCity" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderVendorDetailDTO">
        select
            ma1110.min_order_qty
        from ma1110
        where
        ma1110.article_id = #{articleId,jdbcType = VARCHAR}
        and ma1110.vendor_id = #{vendorId,jdbcType=VARCHAR}
        and #{businessDate,jdbcType=VARCHAR} BETWEEN ma1110.effective_start_date AND ma1110.effective_end_date
        and ma1110.structure_cd = (
                    select admin_structure_cd from ma0020
                    where structure_cd = (
                            select admin_structure_cd from ma0020
                            where structure_cd = #{storeCd,jdbcType=VARCHAR}
                    )
            )
    </select>

    <select id="getConditionQty" resultType="java.math.BigDecimal">
        select condition_qty from ma4031
        where
        promotion_cd = #{promotionCd}
        and article_id = #{articleId}
        limit 1
    </select>

    <select id="getPresentArticle" resultType="cn.com.bbut.iy.itemmaster.dto.order.PromotionDTO">
        select
            ma4032.present_article_id article_id,
            ma4032.present_qty,
            ma1100.receive_unit_id unit_id
         from ma4032,ma1100
        where
        promotion_cd = #{promotionCd}
        and condition_article_id = #{articleId}
        and ma4032.present_article_id = ma1100.article_id
        and (SELECT sp_value FROM cm9060 WHERE sp_id = '0000') BETWEEN ma1100.effective_start_date AND ma1100.effective_end_date
    </select>

    <update id="updateOrderEffStsByVendor">
        UPDATE od8020 SET order_sts = '2'
        WHERE
        order_sts = '1'
        and dc_item = '0'
        and order_date = #{businessDate,jdbcType=VARCHAR}
        and store_cd = #{storeCd,jdbcType=VARCHAR}
        and vendor_id = #{vendorId,jdbcType=VARCHAR}
    </update>

    <update id="updateOrderExpStsByVendor">
        UPDATE od8020 SET order_sts = '1'
            WHERE order_sts = '2'
            and dc_item = '0'
            and order_date = #{businessDate,jdbcType=VARCHAR}
            and vendor_id = #{vendorId,jdbcType=VARCHAR}
            and store_cd = #{storeCd,jdbcType=VARCHAR}
    </update>
    <update id="updateOrderEffStsByGroup">
        update od8020 set order_sts = '2'
        from ma2400
        where
            od8020.article_id = ma2400.article_id
            and od8020.order_sts = '1'
            and od8020.dc_item = '0'
            and od8020.order_date = #{businessDate,jdbcType=VARCHAR}
            and od8020.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
            and ma2400.structure_cd = (
                    select admin_structure_cd from ma0020
                    where structure_cd = (
                            select admin_structure_cd from ma0020
                            where structure_cd = #{storeCd,jdbcType=VARCHAR}
                    )
            )
            and ma2400.group_code = #{groupCode,jdbcType=VARCHAR}
    </update>
    <update id="updateOrderExpStsByGroup">
        update od8020 set order_sts = '1'
        from ma1110
        where
            od8020.article_id = ma1110.article_id
            and od8020.order_sts = '2'
            and od8020.dc_item = '0'
            and od8020.order_date = #{businessDate,jdbcType=VARCHAR}
            and od8020.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and od8020.store_cd = #{storeCd,jdbcType=VARCHAR}
            and #{businessDate,jdbcType=VARCHAR}
                BETWEEN ma1110.effective_start_date AND ma1110.effective_end_date
            and ma1110.structure_cd = (
                    select admin_structure_cd from ma0020
                    where structure_cd = (
                            select admin_structure_cd from ma0020
                            where structure_cd = #{storeCd,jdbcType=VARCHAR}
                    )
            )
            and ma1110.product_group_cd = #{productGroupCd,jdbcType=VARCHAR}
    </update>

    <select id="getMa1107" resultType="cn.com.bbut.iy.itemmaster.dto.base.AutoCompleteDTO">
        select ma07.pog_cd k,ma07.pog_name v
         from ma1107 ma07, ma1104 ma04
            where ma07.EFFECTIVE_STS='10'
            and ma07.store_cd = #{storeCd,jdbcType=VARCHAR}
						and ma07.pog_cd = ma04.pog_cd
						and ma07.store_cd = ma04.store_cd
						and ma04.is_expired = '0'
        ORDER BY ma07.pog_cd
    </select>

    <select id="getMa1108" resultType="cn.com.bbut.iy.itemmaster.dto.base.AutoCompleteDTO">
        select shelf k,shelf v
         from ma1108
            where EFFECTIVE_STS='10'
            and store_cd = #{storeCd,jdbcType=VARCHAR}
            and pog_cd = #{excelName,jdbcType=VARCHAR}
        ORDER BY shelf
    </select>

    <select id="getMa1109" resultType="cn.com.bbut.iy.itemmaster.dto.base.AutoCompleteDTO">
        select sub_shelf k,sub_shelf v
         from ma1109
            where EFFECTIVE_STS='10'
            and store_cd = #{storeCd,jdbcType=VARCHAR}
            and pog_cd = #{excelName,jdbcType=VARCHAR}
            and shelf = #{paramShelf,jdbcType=VARCHAR}
        ORDER BY sub_shelf
    </select>

    <select id="getUserPosition" resultMap="BaseResultMap">
        select position from ma4210 where
        store_cd = #{storeCd,jdbcType=VARCHAR}
        and user_code = #{userId,jdbcType=VARCHAR}
    </select>

    <!--特殊订单查询-->
    <select id="getOrderSpecialListByDpt" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap">
        select
        can_order.dep_cd,
        can_order.pma_cd,
        can_order.pma_name,
        can_order.dep_name,
        can_order.can_order_count,
        COALESCE ( article_count.num, 0 ) AS article_count,
        COALESCE ( do_order_count.num, 0 ) AS do_order_count
        from
        (
        SELECT ma8040.dep_cd,ma8040.pma_cd,ma0080.pma_name,ma0070.dep_name,
        coalesce(count(DISTINCT ma8040.article_id),0) as can_order_count
        FROM ma8140,ma0070,ma0080,ma2240,ma8040,ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma0070.dep_cd = ma8040.dep_cd
        and ma0080.dep_cd = ma8040.dep_cd and ma0080.pma_cd = ma8040.pma_cd
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        GROUP BY ma8040.dep_cd,ma8040.pma_cd,ma0070.dep_name,ma0080.pma_name
        ) can_order
        left join (select ma8040.dep_cd,ma8040.pma_cd,count(DISTINCT od8020_t.article_id) as num
        from ma8140,ma8040,od8020_t,ma2240,ma5322,ma5323 where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.article_id =  od8020_t.article_id
        AND od8020_t.order_qty !=0
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
        group by dep_cd,pma_cd) do_order_count
        ON do_order_count.dep_cd = can_order.dep_cd and do_order_count.pma_cd = can_order.pma_cd
        left join (select dep_cd,pma_cd,count(DISTINCT ma1100.article_id) as num
        from ma1100,ma1110,ma2240 where
        #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
        <if test="vendorId !=null and vendorId != ''">
            and ma2240.vendor_id = #{vendorId,jdbcType=VARCHAR}
        </if>
        <include refid="MA1100_WHERE_CLAUSE"/>
        group by dep_cd,pma_cd) article_count
        ON article_count.dep_cd = can_order.dep_cd and article_count.pma_cd = can_order.pma_cd
        ORDER BY do_order_count desc, can_order.dep_cd ASC,can_order.pma_cd ASC
        <if test="limitStart >= 0">
            limit ${limitEnd} offset ${limitStart}
        </if>
    </select>

    <select id="getOrderSpecialListByDptCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="java.lang.Long">
        select
        count(*)
        from
        (
        SELECT ma8040.dep_cd,ma8040.pma_cd,ma0080.pma_name,ma0070.dep_name,
        coalesce(count(DISTINCT ma8040.article_id),0) as can_order_count
        FROM ma8140,ma0070,ma0080,ma2240,ma8040,ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma0070.dep_cd = ma8040.dep_cd
        and ma0080.dep_cd = ma8040.dep_cd and ma0080.pma_cd = ma8040.pma_cd and
        ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <include refid="MA8040_WHERE_CLAUSE"/>
        GROUP BY ma8040.dep_cd,ma8040.pma_cd,ma0070.dep_name,ma0080.pma_name
        ) can_order
    </select>
    <!--特殊订单查询-->
    <select id="getOrderSpecialListByShelf" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap">
        SELECT ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,
        coalesce(article_count.num,0) as article_count,
        coalesce(count(distinct ma8040.article_id),0) as can_order_count,
        coalesce(do_order_count.num,0) as do_order_count
        FROM ma8140,ma8040,ma2240,ma1105
        full join (select ma1105.shelf,count(DISTINCT od8020_t.article_id) as num
        from ma8140,ma8040,od8020_t,ma1105,ma2240,ma5322,ma5323 where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.article_id =  od8020_t.article_id
        and ma1105.item_code =  od8020_t.article_id
        and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        AND od8020_t.order_qty !=0
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
        <if test="pogCd != null and pogCd != ''">
            and ma1105.shelf in (
            select shelf from ma1108 where pog_cd = #{pogCd,jdbcType=VARCHAR} and store_cd = #{storeCd,jdbcType=VARCHAR}
            )
        </if>
        <if test="shelf != null and shelf != ''">
            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
        </if>
        <if test="subShelf != null and subShelf != ''">
            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        group by shelf) do_order_count
        ON do_order_count.shelf = ma1105.shelf
        full join (select ma1105.shelf,count(DISTINCT ma1100.article_id) as num
        from ma1100,ma1105,ma1110,ma2240 where ma1105.item_code = ma1100.article_id
        and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR} and #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
        <if test="pogCd != null and pogCd != ''">
            and ma1105.shelf in (
            select shelf from ma1108 where pog_cd = #{pogCd,jdbcType=VARCHAR} and store_cd = #{storeCd,jdbcType=VARCHAR}
            )
        </if>
        <if test="shelf != null and shelf != ''">
            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
        </if>
        <if test="subShelf != null and subShelf != ''">
            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
        </if>
        <include refid="MA1100_WHERE_CLAUSE"/>
        <if test="vendorId !=null and vendorId != ''">
            and ma2240.vendor_id = #{vendorId,jdbcType=VARCHAR}
        </if>
        group by ma1105.shelf) article_count
        ON article_count.shelf = ma1105.shelf
        LEFT JOIN
        (SELECT
        a.shelf,
        b.dep_cd,b.pma_cd,b.category_cd,b.sub_category_cd
        FROM
        (select ma1105.shelf, max(ma1100.article_id) article_id from ma1105,ma1100 where ma1105.item_code = ma1100.article_id GROUP BY ma1105.shelf) a
        left join
        (select article_id,dep_cd,pma_cd,category_cd,sub_category_cd from ma1100 ) b on a.article_id = b.article_id
        ORDER BY a.shelf ASC)
        ma11 ON ma1105.shelf = ma11.shelf
        LEFT JOIN ma0090 ON ma11.category_cd = ma0090.category_cd
        AND ma11.dep_cd = ma0090.dep_cd
        AND ma11.pma_cd = ma0090.pma_cd
        LEFT JOIN ma0100 ON ma11.sub_category_cd = ma0100.sub_category_cd
        AND ma11.dep_cd = ma0100.dep_cd
        AND ma11.pma_cd = ma0100.pma_cd
        AND ma11.category_cd = ma0100.category_cd,
        ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.article_id = ma1105.item_code
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
        <if test="pogCd != null and pogCd != ''">
            and ma1105.shelf in (
            select shelf from ma1108 where pog_cd = #{pogCd,jdbcType=VARCHAR} and store_cd = #{storeCd,jdbcType=VARCHAR}
            )
        </if>
        <if test="shelf != null and shelf != ''">
            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
        </if>
        <if test="subShelf != null and subShelf != ''">
            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        GROUP BY ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,do_order_count.num,article_count.num
        ORDER BY do_order_count DESC,ma1105.shelf ASC
        <if test="limitStart >= 0">
            limit ${limitEnd} offset ${limitStart}
        </if>
    </select>

    <select id="getOrderSpecialListByShelfCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="java.lang.Long">
        SELECT
            count(*)
        from
        (
        SELECT
            ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,
            coalesce(article_count.num,0) as article_count,
            coalesce(count(distinct ma8040.article_id),0) as can_order_count,
            coalesce(do_order_count.num,0) as do_order_count
        FROM ma8140,ma8040,ma2240,ma1105
            full join (
            select ma1105.shelf,count(DISTINCT od8020_t.article_id) as num
            from ma8140,ma8040,od8020_t,ma1105,ma2240,ma5322,ma5323
            where ma8040.article_id = ma8140.article_id
            and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma8040.article_id =  od8020_t.article_id
            and ma1105.item_code =  od8020_t.article_id
            and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
            AND od8020_t.order_qty !=0
            <if test="vendorId !=null and vendorId != ''">
                and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
                and ma8040.dc_item = '0'
            </if>
            and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
            <if test="pogCd != null and pogCd != ''">
                and ma1105.shelf in (
                select shelf from ma1108 where pog_cd = #{pogCd,jdbcType=VARCHAR} and store_cd = #{storeCd,jdbcType=VARCHAR}
                )
            </if>
            <if test="shelf != null and shelf != ''">
                and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
            </if>
            <if test="subShelf != null and subShelf != ''">
                and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
            </if>
            <include refid="MA8040_WHERE_CLAUSE"/>
            group by shelf
        ) do_order_count
        ON do_order_count.shelf = ma1105.shelf
        full join (
            select ma1105.shelf,count(DISTINCT ma1100.article_id) as num
            from ma1100,ma1105,ma1110,ma2240
            where ma1105.item_code = ma1100.article_id
            and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
            and #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
            <if test="pogCd != null and pogCd != ''">
            and ma1105.shelf in (
            select shelf from ma1108 where pog_cd = #{pogCd,jdbcType=VARCHAR} and store_cd = #{storeCd,jdbcType=VARCHAR}
            )
             </if>
            <if test="shelf != null and shelf != ''">
                and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
            </if>
            <if test="subShelf != null and subShelf != ''">
                and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
            </if>
            <include refid="MA1100_WHERE_CLAUSE"/>
            <if test="vendorId !=null and vendorId != ''">
                and ma2240.vendor_id = #{vendorId,jdbcType=VARCHAR}
            </if>
            group by ma1105.shelf
        ) article_count
        ON article_count.shelf = ma1105.shelf
        LEFT JOIN
        (SELECT a.shelf,b.dep_cd,b.pma_cd,b.category_cd,b.sub_category_cd
         FROM (select ma1105.shelf, max(ma1100.article_id) article_id from ma1105,ma1100 where ma1105.item_code = ma1100.article_id GROUP BY ma1105.shelf) a
         left join (select article_id,dep_cd,pma_cd,category_cd,sub_category_cd from ma1100 ) b on a.article_id = b.article_id
        ORDER BY a.shelf ASC) ma11
        ON ma1105.shelf = ma11.shelf
        LEFT JOIN ma0090 ON ma11.category_cd = ma0090.category_cd
        AND ma11.dep_cd = ma0090.dep_cd
        AND ma11.pma_cd = ma0090.pma_cd
        LEFT JOIN ma0100 ON ma11.sub_category_cd = ma0100.sub_category_cd
        AND ma11.dep_cd = ma0100.dep_cd
        AND ma11.pma_cd = ma0100.pma_cd
        AND ma11.category_cd = ma0100.category_cd,
        ma5322,ma5323
        where
        ma8040.article_id = ma8140.article_id
        and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.article_id = ma1105.item_code
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        <if test="vendorId !=null and vendorId != ''">
            and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and ma8040.dc_item = '0'
        </if>
        and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
        <if test="pogCd != null and pogCd != ''">
            and ma1105.shelf in (
            select shelf from ma1108 where pog_cd = #{pogCd,jdbcType=VARCHAR} and store_cd = #{storeCd,jdbcType=VARCHAR}
            )
        </if>
        <if test="shelf != null and shelf != ''">
            and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
        </if>
        <if test="subShelf != null and subShelf != ''">
            and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
        </if>
        <include refid="MA8040_WHERE_CLAUSE"/>
        GROUP BY ma1105.shelf,ma0090.category_name,ma0100.sub_category_name,do_order_count.num,article_count.num
        ORDER BY ma1105.shelf ASC ) c
    </select>

    <select id="getOrderSpecialListDetail" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap1">
        select distinct
            ma8040.article_id,
            ma8040.article_name,
            ma8040.vendor_id,
            ma8040.purchase_unit_id,
            ma8040.base_order_price order_price,
            ma8040.dc_item,
            ma8040.promotion_description,
            coalesce(ma8040.article_qty,0) article_qty,
            concat(ma8040.article_nocharge_id,' ',ma1100.article_name) article_nocharge_id,
            coalesce(ma8040.article_nocharge_qty,0) article_nocharge_qty,
            coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR}
            and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
            coalesce(od8020_t.order_qty,0)+coalesce(od8020_t.order_nocharge_qty,0) AS total_qty,
            od8020_t.order_qty as order_qty,
            od8020_t.order_nocharge_qty,
            od8020_t.upload_flg,
            od8020_t.order_sts,
            od8020_t.upload_order_qty,
            od8020_t.upload_order_nocharge_qty,
            (select ma8070.psd ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and ma8070.article_id=ma8040.article_id) as psd,
            (select avg(sk0020.qty1) from sk0020 where sk0020.store_cd = #{storeCd,jdbcType=VARCHAR} and sk0020.article_id = ma8040.article_id and sk0020.voucher_type = '603'
            and sk0020.voucher_date between to_char(TO_DATE(#{orderDate,jdbcType=VARCHAR},'yyyyMMdd') - INTERVAL '28 day', 'yyyyMMdd') and #{orderDate,jdbcType=VARCHAR}) as write_off_qty
        from ma2240,ma8140,ma1105,ma8040
            full join od8020_t ON od8020_t.article_id=ma8040.article_id
            and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
            left join ma1100 on ma8040.article_nocharge_id = ma1100.article_id
            and #{orderDate,jdbcType=VARCHAR} between ma1100.effective_start_date and ma1100.effective_end_date
            AND ma1100.inventory_item='1',ma5322,ma5323
        where
            ma8040.article_id = ma8140.article_id
            and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
            AND MA8040.inventory_item='1'
            and ma1105.item_code = ma8040.article_id
            and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
            <if test="articleId !=null and articleId != ''">
                and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
            </if>
            <if test="articleName !=null and articleName != ''">
                and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
            </if>
            <if test="barcode !=null and barcode != ''">
                and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
            </if>
            <if test="vendorId !=null and vendorId != ''">
                and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
                and ma8040.dc_item = '0'
            </if>

            <include refid="MA8040_WHERE_CLAUSE"/>
            <if test="shelf !=null and shelf != ''">
                and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
            </if>
            <if test="subShelf !=null and subShelf != ''">
                and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
            </if>
            order by ma8040.article_id ASC
            <if test="limitStart >= 0">
                limit ${limitEnd} offset ${limitStart}
            </if>
    </select>

    <select id="getOrderSpecialListDetailCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="long">
        select count(*) from (
            select distinct
                ma8040.article_id,
                ma8040.article_name,
                ma8040.vendor_id,
                ma8040.purchase_unit_id,
                ma8040.base_order_price,
                ma8040.dc_item,
                ma8040.promotion_description,
                coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR}
                and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
                od8020_t.order_qty as order_qty,
                od8020_t.upload_flg,
                (select ma8070.psd from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and
                ma8070.article_id=ma8040.article_id) as psd,
                (select avg(sk0020.qty1) from sk0020 where sk0020.store_cd = #{storeCd,jdbcType=VARCHAR} and sk0020.article_id = ma8040.article_id and sk0020.voucher_type = '603'
                and sk0020.voucher_date between to_char(TO_DATE(#{orderDate,jdbcType=VARCHAR},'yyyyMMdd') - INTERVAL '28 day', 'yyyyMMdd') and #{orderDate,jdbcType=VARCHAR}) as write_off_qty
            from ma2240,ma8140,ma1105,ma8040
                full join od8020_t ON od8020_t.article_id=ma8040.article_id
                and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR},
                ma5322,ma5323
            where
                ma8040.article_id = ma8140.article_id
                and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
                and ma1105.item_code = ma8040.article_id
                and ma1105.store_cd = #{storeCd,jdbcType=VARCHAR}
                and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
                <if test="articleId !=null and articleId != ''">
                    and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
                </if>
                <if test="articleName !=null and articleName != ''">
                    and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
                </if>
                <if test="barcode !=null and barcode != ''">
                    and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
                </if>
                <if test="vendorId !=null and vendorId != ''">
                    and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
                    and ma8040.dc_item = '0'
                </if>
                <include refid="MA8040_WHERE_CLAUSE"/>
                <if test="shelf !=null and shelf != ''">
                    and ma1105.shelf = #{shelf,jdbcType=VARCHAR}
                </if>
                <if test="subShelf !=null and subShelf != ''">
                    and ma1105.sub_shelf = #{subShelf,jdbcType=VARCHAR}
                </if>
        ) orderCount
    </select>

    <select id="getOrderSpecialListDetailByDpt" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap1">
        select distinct
            ma8040.article_id,
            ma8040.article_name,
            ma8040.vendor_id,
            ma8040.purchase_unit_id,
            ma8040.base_order_price order_price,
            ma8040.dc_item,
            coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR}
            and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
            coalesce(od8020_t.order_qty,0)+coalesce(od8020_t.order_nocharge_qty,0) AS total_qty,
            od8020_t.order_qty as order_qty,
            od8020_t.order_nocharge_qty,
            od8020_t.upload_flg,
            od8020_t.order_sts,
            od8020_t.upload_order_qty,
            od8020_t.upload_order_nocharge_qty,
            (select ma8070.psd ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and ma8070.article_id=ma8040.article_id) as psd
        from ma2240,ma8140,ma8040
            full join od8020_t ON od8020_t.article_id=ma8040.article_id
            and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR},ma5322,ma5323
        where
            ma8040.article_id = ma8140.article_id
            AND MA8040.inventory_item='1'
            and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
            and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
            <if test="articleId !=null and articleId != ''">
                and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
            </if>
            <if test="articleName !=null and articleName != ''">
                and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
            </if>
            <if test="barcode !=null and barcode != ''">
                and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
            </if>
            <if test="vendorId !=null and vendorId != ''">
                and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
                and ma8040.dc_item = '0'
            </if>
            <include refid="MA8040_WHERE_CLAUSE"/>
            order by ma8040.article_id ASC
            <if test="limitStart >= 0">
                limit ${limitEnd} offset ${limitStart}
            </if>
    </select>

    <select id="getOrderSpecialListDetailByDptCount" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultType="long">
        select count(*) from (
            select distinct
                ma8040.article_id,
                ma8040.article_name,
                ma8040.vendor_id,
                ma8040.purchase_unit_id,
                ma8040.base_order_price,
                ma8040.dc_item,
                coalesce((select ma8070.soq ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR}
                and ma8070.article_id=ma8040.article_id),0) as auto_order_qty,
                od8020_t.order_qty as order_qty,
                od8020_t.upload_flg,
                (select ma8070.psd ma8070 from ma8070 where ma8070.store_cd=#{storeCd,jdbcType=VARCHAR} and
                ma8070.article_id=ma8040.article_id) as psd
            from ma2240,ma8140, ma8040
                full join od8020_t ON od8020_t.article_id=ma8040.article_id
                and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR},ma5322,ma5323
            where
                ma8040.article_id = ma8140.article_id
                and ma8140.effective_date = #{orderDate,jdbcType=VARCHAR}
                and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
                <if test="articleId !=null and articleId != ''">
                    and lower(ma8040.article_id) like lower(CONCAT('%',#{articleId,jdbcType=VARCHAR},'%'))
                </if>
                <if test="articleName !=null and articleName != ''">
                    and lower(ma8040.article_name) like lower(CONCAT('%',#{articleName,jdbcType=VARCHAR},'%'))
                </if>
                <if test="barcode !=null and barcode != ''">
                    and lower(ma8140.barcode) like lower(CONCAT('%',#{barcode,jdbcType=VARCHAR},'%'))
                </if>
                <if test="vendorId !=null and vendorId != ''">
                    and ma8040.vendor_id = #{vendorId,jdbcType=VARCHAR}
                    and ma8040.dc_item = '0'
                </if>
                <include refid="MA8040_WHERE_CLAUSE"/>
        ) orderCount
    </select>

    <select id="getOrderSpecialItemDetail" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemParamDTO" resultMap="BaseResultMap2">
        select
        DISTINCT
        c.barcode,
        ma8040.article_id,
        ma8040.vendor_id,
        concat(ma8040.vendor_id,' ',ma2000.vendor_name) vendor_name,
        /* ma2000.min_order_qty vendor_min_order_qty,*/
        ma2002.min_order_qty vendor_min_order_qty,/*供应商最低订货量*/
        (select code_name preserve_type_name from cm9010 where/*储藏信息*/
        ma1100.preserve_type = cm9010.code_value
        and cm9010.code_type = '00130'
        and effective_sts = '10') preserve_type_name,
        ma8040.spec,
        ma8040.promotion_description,
        ma0220.unit_name,
        /*ma8040.purchase_unit_id,*/
        ma8040.min_display_qty,
        ma8040.order_unit_qty,
        COALESCE(ma8040.min_order_qty, 0) min_order_qty,/*最低订货量*/
        COALESCE(ma8040.dc_m_order_qty, 0) dc_min_order_qty,/*dc moq*/
        ma8040.max_order_qty,
        ma8040.min_order_amt_tax,/*最低订货金额*/
        ma8040.order_batch_qty,
        (select code_name order_promotion_type from cm9010 where/*进价促销类型*/
        ma8040.order_promotion_type = cm9010.code_value
        and cm9010.code_type = '00826'
        and effective_sts = '10') order_promotion_type,
        ma8040.base_order_price order_price,
        ma8040.advise_sale_price,
        sk0000_today.dms,
        ma8040.warranty_days,
        ma8040.receive_date_limit,
        ma8040.sale_date_limit
        from ma8040
        left join
        sk0000_today on  ma8040.article_id = sk0000_today.article_id
        AND sk0000_today.effective_date = #{orderDate,jdbcType=VARCHAR}
        and sk0000_today.store_cd = #{storeCd,jdbcType=VARCHAR},
        ma0220,ma1100,ma2240,
        (SELECT
        ma1110.article_id,
        ma1110.vendor_id,
        ma1110.default_barcode  AS barcode,
        ma1110.structure_cd
        FROM
        ma1110
        WHERE
        #{orderDate,jdbcType=VARCHAR} between ma1110.effective_start_date and ma1110.effective_end_date
        ) c,
        ma2000
        left join ma2002 on
        ma2002.effective_start_date = ma2000.effective_start_date
        AND ma2000.vendor_id = ma2002.vendor_id
        /*限制区域*/
        and ma2002.structure_cd = (
        select admin_structure_cd from MA0020 where structure_cd =
        (SELECT admin_structure_cd FROM MA0020 WHERE structure_cd = #{storeCd,jdbcType=VARCHAR} and effective_sts = '10') and effective_sts = '10'
        )
        where
        ma8040.article_id = c.article_id
        and ma8040.structure_cd = c.structure_cd
        and ma8040.vendor_id = c.vendor_id
        /*限制区域*/
        and ma8040.structure_cd = (
        select admin_structure_cd from MA0020 where structure_cd =
        (SELECT admin_structure_cd FROM MA0020 WHERE structure_cd = #{storeCd,jdbcType=VARCHAR} and effective_sts = '10') and effective_sts = '10'
        )
        /*限制为dc商品*/
        <if test="dcItem != null and dcItem != ''">
            and ma8040.dc_item = #{dcItem,jdbcType=VARCHAR}
        </if>
        /*取对应供应商商品*/
        and ma2240.store_cd = #{storeCd,jdbcType=VARCHAR}
        and ma2240.article_id = ma8040.article_id
        and ma2240.vendor_id = ma8040.vendor_id
        /*限制订货为非暂停*/
        and (CASE
        when ma8040.dc_item = '1' then ma8040.order_pause_dc_flg = '1'
        when ma8040.dc_item = '0' then ma8040.order_pause_flg = '1'
        END)
        and ma8040.article_id = #{articleId,jdbcType=VARCHAR}
        and ma8040.effective_date = #{orderDate,jdbcType=VARCHAR}
        and ma8040.vendor_id= ma2000.vendor_id
        and ma1100.article_id = ma8040.article_id
        and #{orderDate,jdbcType=VARCHAR} BETWEEN ma1100.effective_start_date AND ma1100.effective_end_date
        and ma0220.unit_id =ma8040.purchase_unit_id
        <![CDATA[
      and #{orderDate,jdbcType=VARCHAR}>= ma2000.effective_start_date
      and #{orderDate,jdbcType=VARCHAR}<= ma2000.effective_end_date;
      ]]>
    </select>

    <select id="selectSpecialOrder" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO" resultMap="BaseResultMap1">
        select article_id,order_qty,upload_order_qty from od8020_t
        where article_id = #{articleId,jdbcType=VARCHAR}
        and store_cd = #{storeCd,jdbcType=VARCHAR}
    </select>

    <delete id="deleteSpecialOrder"  parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        delete from od8020_t
        where od8020_t.article_id = #{articleId,jdbcType=VARCHAR}
        and od8020_t.order_date = #{orderDate,jdbcType=CHAR}
        and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
    </delete>

    <update id="updateSpecialOrder" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        update od8020_t
        <if test="orderQty!=null">
            set order_qty = #{orderQty,jdbcType=NUMERIC},
        </if>
        <if test="orderPrice!=null">
            order_price = #{orderPrice,jdbcType=NUMERIC},
        </if>
        <if test="vendorId!=null">
            vendor_id = #{vendorId,jdbcType=VARCHAR},
        </if>
        <if test="dcItem!=null">
            dc_item = #{dcItem,jdbcType=CHAR},
        </if>
        <if test="orderSts!=null">
            order_sts = #{orderSts,jdbcType=CHAR},
        </if>
        update_user_id = #{updateUserId,jdbcType=NUMERIC},
        update_ymd = #{updateYmd,jdbcType=CHAR},
        update_hms = #{updateHms,jdbcType=CHAR}
        where od8020_t.article_id = #{articleId,jdbcType=VARCHAR}
        and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
    </update>

    <insert id="insertSpecialOrder" parameterType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        insert into od8020_t
            (store_cd, order_date, article_id, shipment_cd, vendor_id, receive_unit_id, order_qty, order_price,
            create_user_id, create_ymd, create_hms, update_user_id, update_ymd, update_hms, dc_item, order_sts)
            VALUES (#{storeCd,jdbcType=CHAR},
                    #{orderDate,jdbcType=CHAR},
                    #{articleId,jdbcType=VARCHAR},
                    #{shipmentCd,jdbcType=CHAR},
                    #{vendorId,jdbcType=CHAR},
                    #{purchaseUnitId,jdbcType=VARCHAR},
                    #{orderQty,jdbcType=NUMERIC},
                    #{orderPrice,jdbcType=NUMERIC},
                    #{createUserId,jdbcType=VARCHAR},
                    #{createYmd,jdbcType=CHAR},
                    #{createHms,jdbcType=CHAR},
                    #{updateUserId,jdbcType=VARCHAR},
                    #{updateYmd,jdbcType=CHAR},
                    #{updateHms,jdbcType=CHAR},
                    #{dcItem,jdbcType=CHAR},
                    #{orderSts,jdbcType=CHAR}
                    )
    </insert>

    <update id="updateSpecialOrderExpStsByVendor">
        UPDATE od8020_t SET order_sts = '1'
            WHERE order_sts = '2'
            and dc_item = '0'
            and vendor_id = #{vendorId,jdbcType=VARCHAR}
            and store_cd = #{storeCd,jdbcType=VARCHAR}
    </update>

    <select id="getSpecialOrderInfoByVendor" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        SELECT
            vendor_id,sum(coalesce(order_qty,0)) order_qty,sum(coalesce(order_qty,0)*coalesce(order_price,0)) order_price
        FROM od8020_t
            where
            store_cd = #{storeCd,jdbcType=VARCHAR}
            and dc_item = '0'  GROUP BY vendor_id
    </select>

    <select id="getSpecialOrderInfoByVendorGroup" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        SELECT
            sum(coalesce(order_qty,0)) order_qty,sum(coalesce(order_qty,0)*coalesce(order_price,0)) order_price
        FROM od8020_t
            where
            store_cd = #{storeCd,jdbcType=VARCHAR}
            and dc_item = '0'
			and vendor_id = #{vendorId,jdbcType = VARCHAR}
			and article_id in (
				select article_id from ma2400 where
					ma2400.vendor_id = #{vendorId,jdbcType = VARCHAR}
					AND ma2400.group_code = #{groupCode,jdbcType=VARCHAR}
					AND ma2400.structure_cd = (
						SELECT
							admin_structure_cd
						FROM
							ma0020
						WHERE
							structure_cd = ( SELECT admin_structure_cd FROM ma0020 WHERE structure_cd = #{storeCd,jdbcType = VARCHAR})))
    </select>

    <update id="updateSpecialOrderEffStsByGroup">
        update od8020_t set order_sts = '2'
        from ma2400
        where
            od8020_t.article_id = ma2400.article_id
            and od8020_t.order_sts = '1'
            and od8020_t.dc_item = '0'
            and od8020_t.vendor_id = #{vendorId,jdbcType=VARCHAR}
            and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
            and ma2400.structure_cd = (
                    select admin_structure_cd from ma0020
                    where structure_cd = (
                            select admin_structure_cd from ma0020
                            where structure_cd = #{storeCd,jdbcType=VARCHAR}
                    )
            )
            and ma2400.group_code = #{groupCode,jdbcType=VARCHAR}
    </update>

    <update id="updateSpecialOrderEffStsByVendor">
        UPDATE od8020_t SET order_sts = '2'
        WHERE
        order_sts = '1'
        and dc_item = '0'
        and store_cd = #{storeCd,jdbcType=VARCHAR}
        and vendor_id = #{vendorId,jdbcType=VARCHAR}
    </update>

    <select id="checkVendorSpecialOrder" resultType="java.lang.Integer">
        select count(*) from od8020_t
        where
        dc_item = '0'
        and store_cd = #{storeCd,jdbcType=VARCHAR}
    </select>

    <select id="checkSpecialOrder" resultMap="BaseResultMap1">
         select od8020_t.store_cd,od8020_t.article_id,ma1100.article_name from od8020_t,ma1100
        where
        od8020_t.dc_item = '0'
        and od8020_t.order_sts = '1'
				and od8020_t.article_id = ma1100.article_id
				and od8020_t.order_date BETWEEN ma1100.effective_start_date and ma1100.effective_end_date
        and od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
        and od8020_t.order_date = #{orderDate,jdbcType=VARCHAR}
    </select>

    <select id="getSpecialOrderInfoByItem" resultType="cn.com.bbut.iy.itemmaster.dto.order.OrderItemDetailDTO">
        SELECT
            od8020_t.article_id,ma1100.article_name,od8020_t.vendor_id,ma2000.vendor_name,
            coalesce(order_qty,0) order_qty,(coalesce(order_qty,0)*coalesce(order_price,0)) order_price
        FROM od8020_t,ma2000,ma1100
            where
            od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
            and od8020_t.article_id = ma1100.article_id
            and #{businessDate,jdbcType = VARCHAR} BETWEEN ma1100.effective_start_date AND ma2000.effective_end_date
            and #{businessDate,jdbcType = VARCHAR} BETWEEN ma2000.effective_start_date AND ma2000.effective_end_date
            and od8020_t.vendor_id = ma2000.vendor_id
            and od8020_t.dc_item = '0'
    </select>

    <select id="getMiddleListBy" parameterType="String" resultMap="BaseResultMap1">
        select * from od8020_t
        where store_cd = #{storeCd,jdbcType=VARCHAR}
    </select>

    <insert id="insertItemByCopy">
        insert into od8020
        select
        store_cd,#{businessDate,jdbcType=VARCHAR},article_id,shipment_cd,vendor_id,receive_unit_id,
        order_qty,order_nocharge_qty,order_price,upload_flg,upload_date,create_user_id,create_ymd,
        create_hms,update_user_id,update_ymd,update_hms,update_screen_id,update_ip_address,nr_update_flg,
        nr_ymd,nr_hms,dc_item,order_sts,upload_order_qty,upload_order_nocharge_qty
        from od8020_t
        where od8020_t.store_cd = #{storeCd,jdbcType=VARCHAR}
    </insert>

    <delete id="deleteByCopy">
        delete from od8020_t
        where store_cd = #{storeCd,jdbcType=VARCHAR}
    </delete>
</mapper>